<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - agutidesigns</title>
    <link rel="icon" type="image/png" href="https://agutidesigns.vercel.app/images/favicon2.png">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PQTBG3ZZ');</script>
    <!-- End Google Tag Manager -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f7f7f7;
        }

        /* ===== LOGIN PAGE ===== */
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #f7f7f7;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo p {
            color: #666;
            font-size: 0.9rem;
        }

        .login-box {
            background: white;
            max-width: 450px;
            width: 100%;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        .login-header {
            background: #0046FE;
            margin: -40px -40px 30px -40px;
            padding: 30px 40px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            color: white;
        }

        .login-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .login-header p {
            opacity: 0.95;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e8eaed;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #0046FE;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 70, 254, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            background: #0046FE;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            background: #0036C8;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 70, 254, 0.25);
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
        }

        /* ===== DASHBOARD LAYOUT ===== */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard-layout {
            display: flex;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #e8eaed;
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }

        .sidebar-logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid #e8eaed;
            text-align: center;
        }

        .sidebar-logo img {
            height: 45px;
            margin-bottom: 12px;
        }
        
        .sidebar-logo .logo-mobile {
            display: none; /* Ocultar logo blanco en desktop */
        }
        
        .sidebar-logo .logo-desktop {
            display: block; /* Mostrar logo azul en desktop */
        }

        .sidebar-logo p {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
        }

        .sidebar-nav {
            margin-top: 20px;
        }

        .nav-item {
            padding: 14px 20px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            margin: 5px 15px;
            border-radius: 10px;
        }

        .nav-item:hover {
            background: #f5f5f5;
            color: #0046FE;
        }

        .nav-item.active {
            background: #e8f4ff;
            color: #0046FE;
            font-weight: 600;
        }

        .nav-item .icon {
            font-size: 1.3rem;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            padding: 0 20px;
        }

        .btn-logout {
            width: 100%;
            padding: 12px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #e0e0e0;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
            min-height: 100vh;
        }

        .content-header {
            margin-bottom: 30px;
        }

        .content-header h1 {
            color: #1B1B1B;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .content-header p {
            color: #666;
            font-size: 0.95rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #0046FE 0%, #0036C8 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #009A62 0%, #007A4F 100%);
        }

        .stat-card.yellow {
            background: linear-gradient(135deg, #E5FC63 0%, #D4EB52 100%);
            color: #1B1B1B;
        }

        .stat-card.red {
            background: linear-gradient(135deg, #EC6746 0%, #D85635 100%);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 0.85rem;
            opacity: 0.85;
            margin-top: 8px;
        }

        /* ===== CARDS ===== */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e8eaed;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e8eaed;
        }

        .card-header h2 {
            color: #1B1B1B;
            font-size: 1.3rem;
        }

        .btn-primary {
            background: #0046FE;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #0036C8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #EC6746;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-success {
            background: #009A62;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-filter {
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-filter:hover {
            background: #f8f9fa;
            border-color: #0046FE;
            color: #0046FE;
        }

        .btn-filter.active {
            background: #0046FE;
            color: white;
            border-color: #0046FE;
        }

        /* ===== TABLE ===== */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
            font-size: 0.9rem;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-blue {
            background: #e7f1ff;
            color: #0046FE;
        }

        /* ===== KANBAN BOARD ===== */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .kanban-column {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            min-height: 400px;
        }

        .kanban-header {
            font-weight: 700;
            color: #1B1B1B;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-count {
            background: #0046FE;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        .kanban-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: move;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .kanban-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .kanban-card-title {
            font-weight: 700;
            color: #1B1B1B;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .kanban-card-info {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0046FE, #009A62);
            transition: width 0.3s ease;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #1B1B1B;
            font-size: 1.5rem;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* ===== LOADER ===== */
        .loader {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0046FE;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulseAdmin {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.08);
            }
        }
        
        .notification-badge-admin {
            box-shadow: 0 0 10px rgba(0, 70, 254, 0.5);
        }

        /* ===== VIDEO GRID ===== */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .video-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: translateY(-4px);
        }

        .video-thumbnail {
            width: 100%;
            height: 180px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
        }

        .video-info {
            padding: 15px;
        }

        .video-title {
            font-weight: 700;
            color: #1B1B1B;
            margin-bottom: 8px;
        }

        .video-meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 12px;
        }

        .video-actions {
            display: flex;
            gap: 8px;
        }

        /* ===== WEBS DESPLEGADAS GRID (ManageWP Style) ===== */
        .webs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .web-card {
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
                flex-direction: column;
                gap: 15px;
        }

        .web-card:hover {
            box-shadow: 0 6px 20px rgba(0,70,254,0.12);
            border-color: #0046FE;
            transform: translateY(-2px);
        }

        .web-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .web-domain {
            flex: 1;
            min-width: 0;
        }

        .web-domain h3 {
            font-size: 1.1rem;
            color: #1B1B1B;
            margin: 0 0 5px 0;
            font-weight: 700;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .web-url {
            font-size: 0.85rem;
            color: #0046FE;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .web-url:hover {
            text-decoration: underline;
        }

        .web-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .web-status-activo {
            background: #d4edda;
            color: #155724;
        }

        .web-status-inactivo {
            background: #fff3cd;
            color: #856404;
        }

        .web-status-mantenimiento {
            background: #cce5ff;
            color: #004085;
        }

        .web-status-en_construccion {
            background: #fff3cd;
            color: #856404;
        }

        .web-status-cancelled {
            background: #fecaca;
            color: #dc2626;
            font-weight: 700;
        }

        .web-card-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px 0;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
        }

        .web-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
                font-size: 0.9rem;
            }

        .web-info-label {
            color: #666;
            font-weight: 500;
        }

        .web-info-value {
            color: #1B1B1B;
            font-weight: 600;
        }

        .web-plan-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .plan-basico {
            background: #e3f2fd;
            color: #1976d2;
        }

        .plan-avanzado {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .plan-premium {
            background: #fff3e0;
            color: #e65100;
        }

        .web-card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-web-action {
            flex: 1;
            min-width: 100px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-web-visit {
            background: #0046FE;
            color: white;
        }

        .btn-web-visit:hover {
            background: #0036C8;
        }

        .btn-web-manage {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-web-manage:hover {
            background: #e9ecef;
            border-color: #999;
        }

        .btn-web-details {
            background: #6c757d;
            color: white;
        }

        .btn-web-details:hover {
            background: #5a6268;
        }

        /* ==================================
           ELEMENTOS SOLO M√ìVIL (ocultos en desktop)
           ================================== */
        
        .sidebar .sidebar-logo {
            display: flex; /* Mostrar siempre */
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .close-menu-btn {
            display: none; /* Ocultar en desktop */
        }

        .hamburger-btn {
            display: none !important;
        }

        .menu-overlay {
            display: none;
        }

        /* ==================================
           RESPONSIVE DESIGN - M√ìVIL
           ================================== */

        @media (max-width: 1200px) {
            .main-content {
                padding: 25px;
            }

            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            /* LOGIN PAGE */
            .login-container {
                padding: 20px 15px;
            }

            .login-box {
                max-width: 100%;
                padding: 25px;
                margin: 0 15px;
            }

            .login-header {
                margin: -25px -25px 25px -25px;
                padding: 25px 20px;
                border-radius: 20px 20px 0 0;
            }

            .login-header h1 {
                font-size: 1.4rem;
            }

            .login-header p {
                font-size: 0.9rem;
            }

            /* HAMBURGER MENU M√ìVIL */
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                bottom: 0;
                width: 100%;
                height: 100vh;
                flex-direction: column;
                background: white;
                border-right: none;
                padding: 20px 0;
                z-index: 10000;
                box-shadow: 2px 0 20px rgba(0,0,0,0.1);
                transition: left 0.3s ease;
                overflow-y: auto;
            }

            .sidebar.show {
                left: 0;
            }

            .sidebar .sidebar-logo {
                display: flex !important; /* Mostrar en m√≥vil */
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 2px solid #e5e7eb;
                background: linear-gradient(135deg, #0046FE 0%, #0035c9 100%);
                position: relative;
            }

            .sidebar-logo img {
                height: 35px;
            }
            
            .sidebar-logo .logo-desktop {
                display: none !important; /* Ocultar logo azul en m√≥vil */
            }
            
            .sidebar-logo .logo-mobile {
                display: block !important; /* Mostrar logo blanco en m√≥vil */
            }

            .sidebar-logo p {
                color: white !important;
                margin: 5px 0 0 0 !important;
                font-size: 0.75rem !important;
                font-weight: 600 !important;
            }

            .close-menu-btn {
                display: flex !important; /* Mostrar en m√≥vil */
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                font-size: 1.2rem;
                cursor: pointer;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }

            .close-menu-btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: rotate(90deg);
            }

            .sidebar-divider {
                display: block;
                margin: 10px 20px;
            }

            .sidebar-menu {
                flex-direction: column;
                overflow: visible;
                gap: 5px;
                padding: 20px 15px;
                width: 100%;
            }

            .sidebar-menu button {
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
                gap: 15px;
                padding: 15px 20px;
                width: 100%;
                border-radius: 12px;
                font-size: 1rem;
                text-align: left;
            }

            .sidebar-menu button::before {
                font-size: 1.4rem;
                margin-right: 0;
            }

            .sidebar-menu button.active {
                background: #f0f7ff;
                color: #0046FE;
                font-weight: 600;
            }

            .btn-logout {
                display: block;
                margin: auto 15px 15px 15px;
                background: #fee2e2;
                color: #dc2626;
                font-weight: 600;
                padding: 12px 20px;
                border-radius: 10px;
                border: 2px solid #fecaca;
                transition: all 0.3s ease;
                font-size: 0.95rem;
            }

            .btn-logout:hover {
                background: #fecaca;
                border-color: #dc2626;
                transform: translateY(-2px);
            }

            /* Bot√≥n hamburger */
            .hamburger-btn {
                display: flex !important; /* Mostrar en m√≥vil */
                position: fixed;
                bottom: 20px;
                left: 20px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #0046FE;
                color: white;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0, 70, 254, 0.3);
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }

            .hamburger-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(0, 70, 254, 0.4);
            }

            .hamburger-btn:active {
                transform: scale(0.95);
            }

            /* Overlay oscuro */
            .menu-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9998;
                display: none !important; /* Oculto por defecto */
                backdrop-filter: blur(4px);
            }

            .menu-overlay.show {
                display: block !important; /* Mostrar cuando .show */
            }

            /* MAIN CONTENT */
            .main-content {
                margin-left: 0;
                margin-bottom: 0;
                padding: 20px 15px;
                padding-bottom: 90px;
            }

            /* Ocultar hamburger en desktop */
            .hamburger-btn {
                display: flex !important;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
                padding: 20px;
            }

            .header-left h1 {
                font-size: 1.5rem;
            }

            /* Ocultar header-right en m√≥vil */
            .header-right {
                display: none;
            }

            /* STATS */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-value {
                font-size: 2rem;
            }

            /* KANBAN */
            .kanban-board {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .kanban-column {
                min-width: 100%;
            }

            .kanban-header {
                padding: 12px 15px;
            }

            .kanban-header h3 {
                font-size: 1rem;
            }

            .kanban-card {
                padding: 15px;
            }

            .kanban-card h4 {
                font-size: 0.95rem;
            }

            /* TABLAS */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 700px;
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px 8px;
            }

            /* MODALES */
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                padding: 25px 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header h2 {
                font-size: 1.3rem;
            }

            .modal-form .form-group {
                margin-bottom: 15px;
            }

            .modal-form input,
            .modal-form select,
            .modal-form textarea {
                padding: 10px;
                font-size: 14px;
            }

            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .modal-buttons button {
                width: 100%;
            }

            /* CARDS */
            .content-card {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            /* FILTROS */
            .filters {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .filters input,
            .filters select {
                width: 100%;
            }

            /* GRID DE WEBS */
            .webs-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .web-card {
                padding: 20px 15px;
            }

            /* TICKETS */
            .ticket-card {
                padding: 15px;
            }

            .ticket-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            /* FACTURAS */
            .invoice-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .invoice-table {
                overflow-x: auto;
            }

            /* PEDIDOS */
            .order-card {
                padding: 15px;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            /* CLIENTES */
            .client-card {
                padding: 15px;
            }

            /* BOTONES */
            .btn-primary,
            .btn-secondary,
            .btn-danger {
                padding: 10px 18px;
                font-size: 0.85rem;
            }

            .btn-group {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }

            .btn-group button {
                width: 100%;
            }

            /* FILTROS DE FACTURAS */
            .invoice-filters {
                flex-direction: column;
                gap: 10px;
            }

            .invoice-filters button {
                width: 100%;
            }

            /* CANCELACIONES */
            .cancellation-card {
                padding: 15px;
            }

            /* ESTAD√çSTICAS */
            .chart-container {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 15px 10px;
                padding-bottom: 90px;
            }

            .dashboard-header {
                padding: 15px;
            }

            .header-left h1 {
                font-size: 1.3rem;
            }

            .stat-card {
                padding: 15px 12px;
            }

            .stat-value {
                font-size: 1.6rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .sidebar-menu button {
                padding: 5px 6px;
                font-size: 0.6rem;
            }

            .sidebar-menu button::before {
                font-size: 1.1rem;
            }

            .kanban-card {
                padding: 12px;
            }

            .modal-content {
                padding: 20px 15px;
            }

            table {
                font-size: 0.8rem;
            }

            .btn-primary,
            .btn-secondary {
                padding: 8px 14px;
                font-size: 0.8rem;
            }

            .login-box {
                padding: 30px 20px;
            }
        }

        /* Landscape en m√≥vil */
        @media (max-width: 768px) and (orientation: landscape) {
            .sidebar {
                height: 60px;
            }

            .sidebar-menu button {
                padding: 5px 6px;
                font-size: 0.6rem;
            }

            .main-content {
                margin-bottom: 60px;
                padding: 15px;
            }

            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Estilos para botones de filtro de facturas */
        .btn-filter:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15) !important;
        }

        .btn-filter:active {
            transform: translateY(0) !important;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PQTBG3ZZ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- ===== LOGIN PAGE ===== -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-header">
            <h1>üîí Admin Login</h1>
            <p>Dashboard de agutidesigns</p>
            </div>
            <div class="error-message" id="errorMessage">Usuario o contrase√±a incorrectos</div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-login">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- ===== DASHBOARD ===== -->
    <div class="dashboard" id="dashboard">
        <!-- Bot√≥n Hamburger (solo m√≥vil) -->
        <button class="hamburger-btn" onclick="toggleMobileMenu()" style="display: none;">
            ‚ò∞
        </button>

        <!-- Overlay oscuro (solo m√≥vil) -->
        <div class="menu-overlay" onclick="toggleMobileMenu()"></div>

        <div class="dashboard-layout">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-logo">
                    <div>
                        <img src="https://agutidesigns.es/wp-content/uploads/2025/01/Logo.svg" alt="agutidesigns" class="logo-desktop" onerror="this.src='https://agutidesigns.vercel.app/images/Logo.svg'">
                        <img src="../images/logo-blanco.svg" alt="agutidesigns" class="logo-mobile">
                        <p>Panel de Administraci√≥n</p>
                    </div>
                    <button class="close-menu-btn" onclick="toggleMobileMenu()">‚úï</button>
                </div>
                
                <div class="sidebar-nav">
                    <div class="nav-item active" onclick="showSection('estadisticas', event)">
                        <span class="icon">üìä</span>
                        <span>Estad√≠sticas</span>
                    </div>
                    <div class="nav-item" onclick="showSection('webs', event)">
                        <span class="icon">üåê</span>
                        <span>Webs (Kanban)</span>
                    </div>
                    <div class="nav-item" onclick="showSection('tickets', event)">
                        <span class="icon">üé´</span>
                        <span>Tickets</span>
                        <span id="unreadTicketsBadge" class="notification-badge-admin" style="display: none; background: #0046FE; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; margin-left: auto; animation: pulseAdmin 2s infinite;"></span>
                    </div>
                    <div class="nav-item" onclick="showSection('pedidos', event)">
                        <span class="icon">üìã</span>
                        <span>Pedidos</span>
                        <span id="newOrdersBadge" class="notification-badge-admin" style="display: none; background: #0046FE; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; margin-left: auto; animation: pulseAdmin 2s infinite;"></span>
                    </div>
                    <div class="nav-item" onclick="showSection('clientes', event)">
                        <span class="icon">üë•</span>
                        <span>Clientes</span>
                    </div>
                    <div class="nav-item" onclick="showSection('videos', event)">
                        <span class="icon">üé•</span>
                        <span>Videos</span>
                    </div>
                    <div class="nav-item" onclick="showSection('webs-desplegadas', event)">
                        <span class="icon">üöÄ</span>
                        <span>Webs Desplegadas</span>
                    </div>
                    <div class="nav-item" onclick="showSection('facturas', event)">
                        <span class="icon">üßæ</span>
                        <span>Facturas</span>
                    </div>
                    <div class="nav-item" onclick="showSection('cancelaciones', event)">
                        <span class="icon">üö´</span>
                        <span>Cancelaciones</span>
                        <span id="newCancellationsBadge" class="notification-badge-admin" style="display: none; background: #0046FE; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; margin-left: auto; animation: pulseAdmin 2s infinite;"></span>
                    </div>
                </div>

                <div class="sidebar-footer">
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
        </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- SECCI√ìN: ESTAD√çSTICAS -->
                <div class="section active" id="section-estadisticas">
                    <div class="content-header">
                        <div>
                            <h1>üìä Estad√≠sticas</h1>
                            <p>Vista general del negocio</p>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <!-- Filtros de tiempo -->
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-filter" data-filter="today" onclick="filterStats('today')">Hoy</button>
                                <button class="btn-filter" data-filter="week" onclick="filterStats('week')">Esta Semana</button>
                                <button class="btn-filter active" data-filter="month" onclick="filterStats('month')">Este Mes</button>
                                <button class="btn-filter" data-filter="year" onclick="filterStats('year')">Este A√±o</button>
                                <button class="btn-filter" data-filter="all" onclick="filterStats('all')">Todo</button>
                            </div>
                            <!-- Selector de fecha personalizado -->
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="date" id="startDate" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem;">
                                <span style="color: #666;">a</span>
                                <input type="date" id="endDate" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem;">
                                <button class="btn-primary" onclick="filterStatsByDateRange()" style="padding: 8px 16px; font-size: 0.9rem;">üìÖ Filtrar</button>
                            </div>
                        </div>
                    </div>

            <div class="stats-grid">
                <div class="stat-card blue">
                            <div class="stat-label">
                                <span>üìù</span>
                                Total Solicitudes
                            </div>
                    <div class="stat-value" id="totalSubmissions">0</div>
                            <div class="stat-change">+12% este mes</div>
                </div>
                <div class="stat-card green">
                            <div class="stat-label">
                                <span>‚úÖ</span>
                                Clientes Activos
                            </div>
                            <div class="stat-value" id="activeClients">0</div>
                            <div class="stat-change">Clientes con plan</div>
                </div>
                <div class="stat-card yellow">
                            <div class="stat-label">
                                <span>‚è≥</span>
                                Sin Plan
                            </div>
                            <div class="stat-value" id="inactiveClients">0</div>
                            <div class="stat-change">Oportunidades de venta</div>
                </div>
                <div class="stat-card green">
                            <div class="stat-label">
                                <span>üí∞</span>
                                Ingresos Totales
                            </div>
                    <div class="stat-value" id="totalRevenue">0‚Ç¨</div>
                            <div class="stat-change">Revenue acumulado</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-label">
                                <span>üí∏</span>
                                Comisi√≥n Dise√±ador
                            </div>
                            <div class="stat-value" id="designerCommission">0‚Ç¨</div>
                            <div class="stat-change">30% del neto (despu√©s de impuestos y comisiones)</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label">
                                <span>üé´</span>
                                Tickets Abiertos
                            </div>
                            <div class="stat-value" id="openTickets">0</div>
                            <div class="stat-change">Requieren atenci√≥n</div>
                        </div>
                        <div class="stat-card red">
                            <div class="stat-label">
                                <span>üåê</span>
                                Webs en Desarrollo
                            </div>
                            <div class="stat-value" id="websInProgress">0</div>
                            <div class="stat-change">Proyectos activos</div>
                </div>
            </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>üìà Distribuci√≥n de Planes</h2>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Plan B√°sico</div>
                                <div class="stat-value" id="planBasico">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Plan Avanzado</div>
                                <div class="stat-value" id="planAvanzado">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Plan Premium</div>
                                <div class="stat-value" id="planPremium">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: WEBS (KANBAN) -->
                <div class="section" id="section-webs">
                    <div class="content-header">
                        <h1>üåê Gesti√≥n de Webs</h1>
                        <p>Vista Kanban de todos los proyectos</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Proyectos</h2>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn-primary" onclick="loadProjects()" style="font-size: 0.9rem;">üîÑ Recargar Proyectos</button>
                                <span style="color: #666; font-size: 0.85rem;">Los proyectos se crean autom√°ticamente al completar el pago</span>
                            </div>
                        </div>
                        
                        <div class="kanban-board">
                            <div class="kanban-column">
                                <div class="kanban-header">
                                    <span>üî¥ Sin Empezar</span>
                                    <span class="kanban-count" id="count-sin-empezar">0</span>
                                </div>
                                <div id="kanban-sin-empezar"></div>
                            </div>
                            <div class="kanban-column">
                                <div class="kanban-header">
                                    <span>üü° En Desarrollo</span>
                                    <span class="kanban-count" id="count-desarrollo">0</span>
                                </div>
                                <div id="kanban-desarrollo"></div>
                            </div>
                            <div class="kanban-column">
                                <div class="kanban-header">
                                    <span>üü† En Revisi√≥n</span>
                                    <span class="kanban-count" id="count-revision">0</span>
                                </div>
                                <div id="kanban-revision"></div>
                            </div>
                            <div class="kanban-column">
                                <div class="kanban-header">
                                    <span>üü¢ Entregada</span>
                                    <span class="kanban-count" id="count-entregada">0</span>
                                </div>
                                <div id="kanban-entregada"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: TICKETS -->
                <div class="section" id="section-tickets">
                    <div class="content-header">
                        <h1 style="display: flex; align-items: center; gap: 12px;">
                            üé´ Sistema de Tickets
                            <span id="unreadTicketsBadgeHeader" style="display: none; background: #0046FE; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0, 70, 254, 0.4); animation: pulseAdmin 2s infinite;"></span>
                        </h1>
                        <p>Gestiona las solicitudes de soporte</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Tickets Recientes</h2>
                            <button class="btn-primary" onclick="loadTickets()">üîÑ Actualizar</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Asunto</th>
                                        <th>Categor√≠a</th>
                                        <th>Prioridad</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="ticketsTable">
                                    <tr>
                                        <td colspan="8">
                                            <div class="loader">
                                                <div class="spinner"></div>
                                                <p>Cargando tickets...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: PEDIDOS -->
                <div class="section" id="section-pedidos">
                    <div class="content-header">
                        <h1>üìã Pedidos</h1>
                        <p>Todas las solicitudes de membres√≠a</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Lista de Pedidos</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-primary" onclick="loadPedidos()">üîÑ Actualizar</button>
                            </div>
                        </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Empresa</th>
                                <th>Email</th>
                                <th>Plan</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                                <tbody id="pedidosTable">
                            <tr>
                                <td colspan="8">
                                    <div class="loader">
                                        <div class="spinner"></div>
                                                <p>Cargando pedidos...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
                </div>

                <!-- SECCI√ìN: CLIENTES -->
                <div class="section" id="section-clientes">
                    <div class="content-header">
                        <h1>üë• Gesti√≥n de Clientes</h1>
                        <p>Todos los usuarios registrados</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Lista de Clientes</h2>
                            <button class="btn-primary" onclick="loadClientes()">üîÑ Actualizar</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Empresa</th>
                                        <th>Plan</th>
                                        <th>Estado</th>
                                        <th>Registro</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="clientesTable">
                                    <tr>
                                        <td colspan="8">
                                            <div class="loader">
                                                <div class="spinner"></div>
                                                <p>Cargando clientes...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: VIDEOS -->
                <div class="section" id="section-videos">
                    <div class="content-header">
                        <h1>üé• Videos Formativos</h1>
                        <p>Gestiona los tutoriales para clientes</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Biblioteca de Videos</h2>
                            <button class="btn-primary" onclick="openNewVideoModal()">+ A√±adir Video</button>
                        </div>
                        <div class="video-grid" id="videosGrid">
                            <div class="loader">
                                <div class="spinner"></div>
                                <p>Cargando videos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: WEBS DESPLEGADAS (ManageWP Style) -->
                <div class="section" id="section-webs-desplegadas">
                    <div class="content-header">
                        <h1>üöÄ Webs Desplegadas</h1>
                        <p>Gestiona todos los sitios web en producci√≥n</p>
                    </div>

                    <!-- Filtros y B√∫squeda -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="padding: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <!-- B√∫squeda -->
                            <div style="flex: 1; min-width: 250px;">
                                <input type="text" id="searchWebsInput" placeholder="üîç Buscar por dominio, cliente o empresa..." style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                            
                            <!-- Filtro Estado -->
                            <div>
                                <select id="filterStatusWebs" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; min-width: 150px;">
                                    <option value="">Todos los estados</option>
                                    <option value="activo">‚úÖ Activo</option>
                                    <option value="inactivo">‚ö†Ô∏è Inactivo / Cancelado</option>
                                </select>
                            </div>
                            
                            <!-- Filtro Plan -->
                            <div>
                                <select id="filterPlanWebs" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; min-width: 150px;">
                                    <option value="">Todos los planes</option>
                                    <option value="basico">Plan B√°sico</option>
                                    <option value="avanzado">Plan Avanzado</option>
                                    <option value="premium">Plan Premium</option>
                                </select>
                            </div>
                            
                            <!-- Bot√≥n Reset -->
                            <button onclick="resetWebsFilters()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                üîÑ Limpiar
                            </button>
                            
                            <!-- Contador -->
                            <div style="margin-left: auto; padding: 10px 20px; background: #f8f9fa; border-radius: 8px; font-weight: 600; color: #333;">
                                <span id="websCounter">0</span> sitios
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Sitios Web -->
                    <div class="webs-grid" id="websGrid">
                        <div class="loader">
                            <div class="spinner"></div>
                            <p>Cargando sitios web...</p>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: FACTURAS -->
                <div class="section" id="section-facturas">
                    <div class="content-header">
                        <h1>üßæ Facturas</h1>
                        <p>Gestiona todas las facturas de Stripe</p>
                    </div>

                    <!-- Filtros de Tiempo -->
                    <div class="card" style="margin-bottom: 25px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="padding: 24px;">
                            <h3 style="margin-bottom: 20px; font-size: 1.1rem; color: #1a1a1a; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.3rem;">üìÖ</span>
                                Filtrar por Per√≠odo
                            </h3>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn-filter" data-period="week" onclick="filterInvoicesByPeriod('week')" style="padding: 12px 24px; border: 2px solid #0046FE; background: linear-gradient(135deg, #0046FE 0%, #0056FF 100%); color: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 70, 254, 0.3); font-size: 0.95rem;">
                                    üìÖ √öltima Semana
                                </button>
                                <button class="btn-filter" data-period="month" onclick="filterInvoicesByPeriod('month')" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; color: #4b5563; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95rem;">
                                    üìÜ √öltimo Mes
                                </button>
                                <button class="btn-filter" data-period="quarter" onclick="filterInvoicesByPeriod('quarter')" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; color: #4b5563; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95rem;">
                                    üìä √öltimo Trimestre
                                </button>
                                <button class="btn-filter" data-period="year" onclick="filterInvoicesByPeriod('year')" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; color: #4b5563; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95rem;">
                                    üìà √öltimo A√±o
                                </button>
                                <button class="btn-filter" data-period="all" onclick="filterInvoicesByPeriod('all')" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; color: #4b5563; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95rem;">
                                    üåê Todas
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Total Facturas -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                        <span style="font-size: 24px;">üßæ</span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; font-weight: 500;">Total Facturas</div>
                                </div>
                                <div style="color: white; font-size: 2.5rem; font-weight: 700; margin-top: 8px;" id="totalInvoices">0</div>
                            </div>
                        </div>

                        <!-- Pagadas -->
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);">
                            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                        <span style="font-size: 24px;">‚úÖ</span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; font-weight: 500;">Pagadas</div>
                                </div>
                                <div style="color: white; font-size: 2.5rem; font-weight: 700; margin-top: 8px;" id="paidInvoices">0</div>
                            </div>
                        </div>

                        <!-- Pendientes -->
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);">
                            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                        <span style="font-size: 24px;">‚è≥</span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; font-weight: 500;">Pendientes</div>
                                </div>
                                <div style="color: white; font-size: 2.5rem; font-weight: 700; margin-top: 8px;" id="pendingInvoices">0</div>
                            </div>
                        </div>

                        <!-- Ingresos Totales -->
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);">
                            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                        <span style="font-size: 24px;">üí∞</span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; font-weight: 500;">Ingresos Totales</div>
                                </div>
                                <div style="color: white; font-size: 2.5rem; font-weight: 700; margin-top: 8px;" id="totalRevenue">0‚Ç¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Facturas -->
                    <div class="card">
                        <div class="card-header">
                            <h2>Lista de Facturas</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-primary" onclick="loadAllInvoices()">üîÑ Actualizar</button>
                                <button class="btn-secondary" onclick="exportInvoices()">üì• Exportar CSV</button>
                            </div>
                        </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∫ Factura</th>
                                <th>Cliente</th>
                                <th>Empresa</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="loader">
                                        <div class="spinner"></div>
                                        <p>Cargando facturas...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                    </div>
                </div>

                <!-- SECCI√ìN: CANCELACIONES -->
                <div class="section" id="section-cancelaciones">
                    <div class="content-header">
                        <h1>üö´ Cancelaciones</h1>
                        <p>Gestiona las cancelaciones de suscripciones</p>
                    </div>

                    <!-- Estad√≠sticas de Cancelaciones -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üö´</div>
                            <div class="stat-content">
                                <div class="stat-value" id="totalCancelledCount">0</div>
                                <div class="stat-label">Canceladas</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚è≥</div>
                            <div class="stat-content">
                                <div class="stat-value" id="pendingCancellationCount">0</div>
                                <div class="stat-label">Pendientes de Expirar</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìÖ</div>
                            <div class="stat-content">
                                <div class="stat-value" id="cancelledThisMonthCount">0</div>
                                <div class="stat-label">Este Mes</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-content">
                                <div class="stat-value" id="lostRevenueAmount">0‚Ç¨</div>
                                <div class="stat-label">Ingreso Perdido/Mes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Cancelaciones -->
                    <div class="card">
                        <div class="card-header">
                            <h2>Suscripciones Canceladas</h2>
                            <button class="btn-primary" onclick="loadCancellations()">üîÑ Actualizar</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Plan</th>
                                        <th>Estado</th>
                                        <th>Fecha Cancelaci√≥n</th>
                                        <th>Expira</th>
                                        <th>Raz√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cancellationsTable">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px;">
                                            <div class="loader">
                                                <div class="spinner"></div>
                                                <p>Cargando cancelaciones...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Modal: Ver/Responder Ticket -->
    <div class="modal" id="ticketModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üé´ Detalles del Ticket</h3>
                <button class="btn-close" onclick="closeTicketModal()">√ó</button>
            </div>
            <div id="ticketDetails"></div>
        </div>
    </div>

    <!-- Modal: Ver Detalles del Pedido -->
    <div class="modal" id="pedidoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Detalles del Pedido</h3>
                <button class="btn-close" onclick="closePedidoModal()">√ó</button>
            </div>
            <div id="pedidoDetails"></div>
        </div>
    </div>

    <!-- Modal: A√±adir Video -->
    <div class="modal" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="videoModalTitle">üé• A√±adir Video</h3>
                <button class="btn-close" onclick="closeVideoModal()">√ó</button>
            </div>
            <form id="videoForm">
                <input type="hidden" id="videoId" value="">
                <div class="form-group">
                    <label>T√≠tulo del Video</label>
                    <input type="text" id="videoTitle" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="videoDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>URL del Video (YouTube/Vimeo)</label>
                    <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." required>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="videoCategory">
                        <option value="tutorial_elementor">Tutorial Elementor</option>
                        <option value="seo">SEO</option>
                        <option value="marketing">Marketing</option>
                        <option value="basico">B√°sico</option>
                        <option value="avanzado">Avanzado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duraci√≥n (ej: 10:30)</label>
                    <input type="text" id="videoDuration" placeholder="10:30">
                </div>
                <div class="form-group">
                    <label>Orden de Visualizaci√≥n</label>
                    <input type="number" id="videoOrder" placeholder="1" min="1" value="1">
                    <small style="color: #666; font-size: 0.85rem;">Define el orden en que aparecer√° el video (1, 2, 3...)</small>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Guardar Video</button>
            </form>
        </div>
    </div>

    <!-- Modal: Nuevo Proyecto -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üåê Nuevo Proyecto</h3>
                <button class="btn-close" onclick="closeProjectModal()">√ó</button>
            </div>
            <form id="projectForm">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="projectClient" required>
                        <option value="">Selecciona un cliente...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nombre del Proyecto</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="projectStatus" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                        <option value="sin_empezar">Sin Empezar</option>
                        <option value="en_desarrollo">En Desarrollo</option>
                        <option value="revision">En Revisi√≥n</option>
                        <option value="entregada">Entregada</option>
                    </select>
                    <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">El estado se cambia arrastrando el proyecto en el Kanban</small>
                </div>
                <div class="form-group">
                    <label>Prioridad</label>
                    <select id="projectPriority">
                        <option value="low">Baja</option>
                        <option value="normal">Normal</option>
                        <option value="high">Alta</option>
                        <option value="urgent">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Deadline</label>
                    <input type="date" id="projectDeadline">
                </div>
                <div class="form-group">
                    <label>Progreso (%)</label>
                    <input type="number" id="projectProgress" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="projectNotes" rows="3"></textarea>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://agutidesigns-production.up.railway.app';

        // ===== VERIFICAR SESI√ìN AL CARGAR =====
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üîê [ADMIN] Verificando sesi√≥n...');
            const adminSession = localStorage.getItem('adminSession');
            
            if (adminSession) {
                try {
                    const session = JSON.parse(adminSession);
                    console.log('‚úÖ [ADMIN] Sesi√≥n encontrada:', session.username);
                    
                    // Mostrar dashboard directamente
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadDashboard();
                } catch (error) {
                    console.error('‚ùå [ADMIN] Error parseando sesi√≥n:', error);
                    localStorage.removeItem('adminSession');
                }
            } else {
                console.log('‚ö†Ô∏è [ADMIN] No hay sesi√≥n, mostrando login');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        // ===== LOGIN =====
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                console.log('üîê [ADMIN] Intentando login...');
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ [ADMIN] Login exitoso');
                    
                    // GUARDAR SESI√ìN EN LOCALSTORAGE
                    const adminSession = {
                        username: username,
                        loginTime: new Date().toISOString(),
                        isAdmin: true
                    };
                    localStorage.setItem('adminSession', JSON.stringify(adminSession));
                    console.log('üíæ [ADMIN] Sesi√≥n guardada en localStorage');
                    
                    // Mostrar dashboard
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadDashboard();
                } else {
                    console.error('‚ùå [ADMIN] Login fallido');
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå [ADMIN] Error de conexi√≥n:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        });

        // ===== LOGOUT =====
        function logout() {
            console.log('üîê [ADMIN] Cerrando sesi√≥n...');
            
            // ELIMINAR SESI√ìN DE LOCALSTORAGE
            localStorage.removeItem('adminSession');
            console.log('üíæ [ADMIN] Sesi√≥n eliminada de localStorage');
            
            // Mostrar login
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // ===== NAVEGACI√ìN =====
        // ==========================================
        // MEN√ö M√ìVIL
        // ==========================================
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.menu-overlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function showSection(sectionName, event = null) {
            console.log(`üîÄ [ADMIN] showSection('${sectionName}') llamada`, event ? 'con evento' : 'program√°ticamente');
            
            // Cerrar men√∫ m√≥vil si est√° abierto
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.menu-overlay');
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            }
            
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Mostrar secci√≥n seleccionada
            const targetSection = document.getElementById(`section-${sectionName}`);
            if (!targetSection) {
                console.error(`‚ùå [ADMIN] Secci√≥n no encontrada: section-${sectionName}`);
                return;
            }
            targetSection.classList.add('active');
            
            // Activar elemento del men√∫ SOLO si hay un evento (click desde el men√∫)
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            } else {
                // Si se llama program√°ticamente, buscar y activar el nav-item correspondiente
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    const onclick = item.getAttribute('onclick');
                    if (onclick && onclick.includes(`'${sectionName}'`)) {
                        item.classList.add('active');
                    }
                });
            }
            
            console.log(`‚úÖ [ADMIN] Secci√≥n '${sectionName}' activada`);
            
            // Cargar datos espec√≠ficos
            switch(sectionName) {
                case 'tickets':
                    loadTickets();
                    break;
                case 'pedidos':
                    console.log('üìã [ADMIN] Entrando en secci√≥n pedidos...');
                    // Verificar si se acaba de ver un pedido para recargar
                    const pedidoViewed = localStorage.getItem('pedidoViewed');
                    if (pedidoViewed) {
                        const viewedTime = parseInt(pedidoViewed);
                        console.log('üîç [ADMIN] Detectado pedidoViewed en localStorage:', {
                            timestamp: viewedTime,
                            elapsed: Date.now() - viewedTime
                        });
                        // Si se vio hace menos de 30 segundos, es v√°lido
                        if (Date.now() - viewedTime < 30000) {
                            console.log('‚úÖ [ADMIN] Pedido reci√©n visto v√°lido, limpiando localStorage y recargando lista...');
                        }
                        localStorage.removeItem('pedidoViewed');
                        console.log('üßπ [ADMIN] localStorage limpiado');
                    }
                    console.log('üîÑ [ADMIN] Llamando a loadPedidos()...');
                    loadPedidos();
                    break;
                case 'clientes':
                    loadClientes();
                    break;
                case 'videos':
                    loadVideos();
                    break;
                case 'webs':
                    loadProjects();
                    break;
                case 'webs-desplegadas':
                    loadWebsDesplegadas();
                    break;
                case 'facturas':
                    loadAllInvoices();
                    break;
                case 'cancelaciones':
                    loadCancellations();
                    break;
            }
        }

        // ===== CARGAR DASHBOARD =====
        async function loadDashboard() {
            await loadStats();
            await loadProjects();
            // Actualizar badges de notificaciones
            updateAdminBadges();
            // Configurar actualizaci√≥n autom√°tica cada 15 segundos
            setInterval(() => {
                updateAdminBadges();
            }, 15000);
        }

        // ===== CARGAR ESTAD√çSTICAS =====
        // Variable global para el filtro actual
        let currentStatsFilter = 'month';

        async function loadStats(startDate = null, endDate = null) {
            try {
                console.log('üìä [ADMIN] Cargando estad√≠sticas...');
                
                // Construir URL con filtros de fecha si existen
                let url = `${API_URL}/api/admin/stats`;
                if (startDate && endDate) {
                    url += `?startDate=${startDate}&endDate=${endDate}`;
                } else if (currentStatsFilter !== 'all') {
                    url += `?filter=${currentStatsFilter}`;
                }
                
                const response = await fetch(url);
                const stats = await response.json();

                console.log('üìä [ADMIN] Estad√≠sticas recibidas:', stats);

                // Actualizar estad√≠sticas principales
                document.getElementById('totalSubmissions').textContent = stats.total || 0;
                document.getElementById('activeClients').textContent = stats.activeClients || 0;
                document.getElementById('inactiveClients').textContent = stats.noPlan || 0;
                document.getElementById('totalRevenue').textContent = (stats.revenue || 0) + '‚Ç¨';
                
                // üí∏ Calcular comisi√≥n del dise√±ador
                const revenue = stats.revenue || 0;
                // F√≥rmula: Neto = Revenue - (Stripe 1.5% + 0.25‚Ç¨) - IVA (21%) - IRPF (15%)
                // Simplificado: Neto ‚âà Revenue * 0.632 (63.2% del ingreso bruto)
                const netRevenue = revenue * 0.632;
                const designerCommission = netRevenue * 0.30; // 30% del neto
                document.getElementById('designerCommission').textContent = designerCommission.toFixed(2) + '‚Ç¨';
                
                console.log('üí∏ [ADMIN] Comisi√≥n dise√±ador calculada:', {
                    revenue: revenue,
                    netRevenue: netRevenue.toFixed(2),
                    commission: designerCommission.toFixed(2)
                });
                
                // Webs en desarrollo
                const websInProgress = document.getElementById('websInProgress');
                if (websInProgress) {
                    websInProgress.textContent = stats.projectsInProgress || 0;
                }
                
                // Distribuci√≥n de planes (si existen)
                if (stats.byPlan) {
                    const planBasico = document.getElementById('planBasico');
                    const planAvanzado = document.getElementById('planAvanzado');
                    const planPremium = document.getElementById('planPremium');
                    
                    if (planBasico) planBasico.textContent = stats.byPlan.basico || 0;
                    if (planAvanzado) planAvanzado.textContent = stats.byPlan.avanzado || 0;
                    if (planPremium) planPremium.textContent = stats.byPlan.premium || 0;
                }
                
                console.log('‚úÖ [ADMIN] Estad√≠sticas cargadas correctamente');
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando stats:', error);
            }
        }

        // Filtrar estad√≠sticas por per√≠odo
        function filterStats(filter) {
            console.log('üîç [ADMIN] Filtrando estad√≠sticas:', filter);
            currentStatsFilter = filter;
            
            // Actualizar botones activos
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Limpiar fechas personalizadas
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            // Recargar estad√≠sticas
            loadStats();
        }

        // Filtrar por rango de fechas personalizado
        function filterStatsByDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Por favor, selecciona ambas fechas', 'warning');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('La fecha de inicio debe ser anterior a la fecha de fin', 'error');
                return;
            }
            
            console.log('üìÖ [ADMIN] Filtrando por rango:', startDate, 'a', endDate);
            
            // Desactivar todos los botones de filtro
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Cargar stats con fechas
            loadStats(startDate, endDate);
        }

        // ===== ACTUALIZAR BADGES DE NOTIFICACIONES =====
        async function updateAdminBadges() {
            try {
                console.log('üîî [ADMIN] Actualizando badges de notificaciones...');
                
                // 1. BADGE DE TICKETS SIN LEER
                try {
                    const ticketsResponse = await fetch(`${API_URL}/api/tickets`);
                    const allTickets = await ticketsResponse.json();
                    
                    // Filtrar tickets de soporte (excluir facturaci√≥n) y contar sin leer
                    const supportTickets = allTickets.filter(t => t.category !== 'facturacion');
                    const unreadTickets = supportTickets.filter(t => t.admin_unread === true).length;
                    
                    const ticketsBadge = document.getElementById('unreadTicketsBadge');
                    if (ticketsBadge) {
                        if (unreadTickets > 0) {
                            ticketsBadge.textContent = unreadTickets;
                            ticketsBadge.style.display = 'inline-block';
                        } else {
                            ticketsBadge.style.display = 'none';
                        }
                    }
                    
                    console.log(`üé´ [ADMIN] Tickets sin leer: ${unreadTickets}`);
                } catch (error) {
                    console.error('‚ùå [ADMIN] Error actualizando badge de tickets:', error);
                }
                
                // 2. BADGE DE PEDIDOS NUEVOS Y MODIFICADOS
                try {
                    const ordersResponse = await fetch(`${API_URL}/api/admin/submissions`);
                    const orders = await ordersResponse.json();
                    
                    // Contar pedidos nuevos (nunca vistos) + pedidos modificados no vistos
                    const newOrders = orders.filter(o => {
                        // Pedido nuevo: nunca ha sido visto
                        const isNew = !o.admin_viewed_at;
                        
                        // Pedido modificado: tiene modificaciones Y no han sido vistas
                        const isModified = o.has_modifications === true && 
                                         (!o.modifications_viewed_at || o.last_modified_at > o.modifications_viewed_at);
                        
                        // Debug detallado para cada pedido
                        if (isNew || isModified) {
                            console.log(`üîî [BADGE] Pedido #${o.id} cuenta para badge:`, {
                                business_name: o.business_name,
                                isNew,
                                isModified,
                                admin_viewed_at: o.admin_viewed_at,
                                has_modifications: o.has_modifications,
                                modifications_viewed_at: o.modifications_viewed_at,
                                last_modified_at: o.last_modified_at
                            });
                        }
                        
                        return isNew || isModified;
                    }).length;
                    
                    const ordersBadge = document.getElementById('newOrdersBadge');
                    if (ordersBadge) {
                        if (newOrders > 0) {
                            ordersBadge.textContent = newOrders;
                            ordersBadge.style.display = 'inline-block';
                        } else {
                            ordersBadge.style.display = 'none';
                        }
                    }
                    
                    console.log(`üìã [ADMIN] Pedidos nuevos/modificados: ${newOrders}`);
                } catch (error) {
                    console.error('‚ùå [ADMIN] Error actualizando badge de pedidos:', error);
                }
                
                // 3. BADGE DE CANCELACIONES NUEVAS
                try {
                    const cancelResponse = await fetch(`${API_URL}/api/admin/cancelaciones`);
                    
                    if (!cancelResponse.ok) {
                        throw new Error(`HTTP ${cancelResponse.status}`);
                    }
                    
                    const cancelaciones = await cancelResponse.json();
                    
                    // Verificar que sea un array
                    if (!Array.isArray(cancelaciones)) {
                        console.warn('‚ö†Ô∏è [ADMIN] Cancelaciones no es un array:', cancelaciones);
                        return;
                    }
                    
                    // Contar cancelaciones de hoy (√∫ltimas 24 horas)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const newCancellations = cancelaciones.filter(c => {
                        const cancelDate = new Date(c.cancelled_at);
                        return cancelDate >= today;
                    }).length;
                    
                    // Verificar si el admin ya vio las cancelaciones
                    const cancellationViewed = localStorage.getItem('cancellationViewed');
                    let shouldShowBadge = newCancellations > 0;
                    
                    if (cancellationViewed && newCancellations > 0) {
                        const viewedTime = parseInt(cancellationViewed);
                        // Si la √∫ltima cancelaci√≥n es anterior a cuando se vio, no mostrar badge
                        const latestCancellation = cancelaciones
                            .filter(c => new Date(c.cancelled_at) >= today)
                            .sort((a, b) => new Date(b.cancelled_at) - new Date(a.cancelled_at))[0];
                        
                        if (latestCancellation) {
                            const cancelTime = new Date(latestCancellation.cancelled_at).getTime();
                            if (cancelTime < viewedTime) {
                                shouldShowBadge = false;
                                console.log('üö´ [ADMIN] Cancelaciones ya vistas, ocultando badge');
                            }
                        }
                    }
                    
                    const cancelBadge = document.getElementById('newCancellationsBadge');
                    if (cancelBadge) {
                        if (shouldShowBadge) {
                            cancelBadge.textContent = newCancellations;
                            cancelBadge.style.display = 'inline-block';
                        } else {
                            cancelBadge.style.display = 'none';
                        }
                    }
                    
                    console.log(`üö´ [ADMIN] Cancelaciones nuevas (hoy): ${newCancellations}${shouldShowBadge ? '' : ' (ya vistas)'}`);
                } catch (error) {
                    console.error('‚ùå [ADMIN] Error actualizando badge de cancelaciones:', error);
                }
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error general actualizando badges:', error);
            }
        }

        // ===== TICKETS =====
        async function loadTickets() {
            try {
                console.log('üé´ [ADMIN] Cargando tickets...');
                const response = await fetch(`${API_URL}/api/tickets`);
                const allTickets = await response.json();
                
                console.log('üé´ [ADMIN] Tickets recibidos:', allTickets.length, 'tickets');
                
                // FILTRAR: Excluir tickets autom√°ticos de cambios de plan (categor√≠a "facturacion")
                const tickets = allTickets.filter(ticket => ticket.category !== 'facturacion');
                
                // üìÖ ORDENAR: M√°s recientes primero (orden cronol√≥gico descendente)
                tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                console.log('üé´ [ADMIN] Tickets despu√©s de filtrar y ordenar:', tickets.length, 'tickets');

                const tbody = document.getElementById('ticketsTable');
                
                if (tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No hay tickets</td></tr>';
                    console.log('‚úÖ [ADMIN] No hay tickets de soporte (se filtraron los tickets de facturaci√≥n)');
                    return;
                }

                tbody.innerHTML = tickets.map(ticket => {
                    // üîµ Determinar si hay mensaje sin leer del cliente
                    const hasUnreadMessage = ticket.admin_unread === true;
                    const rowStyle = hasUnreadMessage 
                        ? 'background: linear-gradient(to right, #e8f4ff 0%, #f0f8ff 100%); border-left: 4px solid #0046FE; font-weight: 500; transition: all 0.3s;' 
                        : 'transition: all 0.3s;';
                    
                    // Badge de prioridad con colores correctos
                    const priorityColors = {
                        'alta': 'danger',
                        'media': 'warning',
                        'baja': 'info'
                    };
                    const priorityBadge = priorityColors[ticket.priority] || 'secondary';
                    
                    // Badge de estado con colores correctos
                    const statusColors = {
                        'abierto': 'warning',
                        'en_proceso': 'info',
                        'cerrado': 'success'
                    };
                    const statusBadge = statusColors[ticket.status] || 'secondary';
                    
                    return `
                        <tr style="${rowStyle}" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='${hasUnreadMessage ? 'linear-gradient(to right, #e8f4ff 0%, #f0f8ff 100%)' : ''}'">
                            <td>
                                <strong>#${ticket.id}</strong> 
                                ${hasUnreadMessage ? '<span style="color: #0046FE; font-size: 1.3rem; margin-left: 5px; animation: pulse 2s infinite;">‚óè</span>' : ''}
                            </td>
                            <td>${ticket.client_name || 'N/A'}</td>
                            <td>
                                ${ticket.subject}
                                ${hasUnreadMessage ? '<span style="display: block; color: #0046FE; font-size: 0.75rem; margin-top: 3px; font-weight: 600;">‚ö° Nuevo mensaje</span>' : ''}
                            </td>
                            <td><span class="badge badge-info">${ticket.category}</span></td>
                            <td><span class="badge badge-${priorityBadge}">${ticket.priority}</span></td>
                            <td><span class="badge badge-${statusBadge}">${ticket.status}</span></td>
                            <td>${formatDate(ticket.created_at)}</td>
                            <td>
                                <button 
                                    class="btn-secondary" 
                                    onclick="viewTicket(${ticket.id})" 
                                    style="${hasUnreadMessage ? 'background: linear-gradient(135deg, #0046FE 0%, #0036C8 100%); color: white; font-weight: 600; border: none; box-shadow: 0 4px 8px rgba(0, 70, 254, 0.3);' : ''}"
                                >
                                    ${hasUnreadMessage ? 'üëÅÔ∏è Ver Nuevo' : 'Ver'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // üîî Contar mensajes sin leer del admin
                const unreadCount = tickets.filter(t => t.admin_unread === true).length;
                console.log('üîî [ADMIN] Mensajes sin leer:', unreadCount);
                
                // Actualizar badge del men√∫ "Tickets"
                updateAdminTicketsBadge(unreadCount);
                
                // Actualizar contador en stats
                const openCount = tickets.filter(t => t.status === 'open').length;
                document.getElementById('openTickets').textContent = openCount;
            } catch (error) {
                console.error('Error cargando tickets:', error);
            }
        }
        
        // üîî Funci√≥n auxiliar para actualizar badge de tickets en el men√∫ Y header
        function updateAdminTicketsBadge(count) {
            // Badge en el men√∫ lateral
            const badgeMenu = document.getElementById('unreadTicketsBadge');
            // Badge en el header de la secci√≥n
            const badgeHeader = document.getElementById('unreadTicketsBadgeHeader');
            
            if (count > 0) {
                // Actualizar badge del men√∫
                if (badgeMenu) {
                    badgeMenu.textContent = count;
                    badgeMenu.style.display = 'inline-block';
                }
                
                // Actualizar badge del header
                if (badgeHeader) {
                    badgeHeader.textContent = `${count} ${count === 1 ? 'nuevo' : 'nuevos'}`;
                    badgeHeader.style.display = 'inline-block';
                }
                
                console.log('üîî [ADMIN] Badge de tickets actualizado:', count, count === 1 ? 'ticket nuevo' : 'tickets nuevos');
            } else {
                // Ocultar ambos badges
                if (badgeMenu) badgeMenu.style.display = 'none';
                if (badgeHeader) badgeHeader.style.display = 'none';
            }
        }

        // Funci√≥n para parsear mensajes concatenados y ordenarlos cronol√≥gicamente
        function parseAndSortMessages(ticket) {
            const messages = [];
            
            // Mensaje inicial del cliente (descripci√≥n)
            const initialTimestamp = new Date(ticket.created_at);
            messages.push({
                type: 'client',
                content: ticket.description,
                timestamp: initialTimestamp,
                isInitial: true
            });
            
            // Parsear respuestas del admin
            if (ticket.admin_response && ticket.admin_response.trim() !== '') {
                // Primero intentar con el nuevo formato [timestamp_ms]
                let adminParts = ticket.admin_response.split(/\n\n--- Respuesta adicional \[(\d+)\] ---\n\n/);
                
                // Si no hay matches con el nuevo formato, intentar con el formato antiguo (compatibilidad)
                if (adminParts.length === 1) {
                    adminParts = ticket.admin_response.split(/\n\n--- Respuesta adicional \((.*?)\) ---\n\n/);
                }
                
                if (adminParts.length === 1) {
                    // Solo una respuesta del admin (sin separadores adicionales)
                    messages.push({
                        type: 'admin',
                        content: adminParts[0].trim(),
                        timestamp: ticket.admin_response_at ? new Date(ticket.admin_response_at) : new Date(ticket.created_at)
                    });
                } else {
                    // M√∫ltiples respuestas del admin - parsear TODAS desde los separadores
                    // La primera respuesta NO tiene separador, usar admin_response_at solo como fallback
                    let firstResponseTime = ticket.admin_response_at ? new Date(ticket.admin_response_at) : new Date(ticket.created_at);
                    
                    // Si hay al menos un separador con timestamp, usar ese como base
                    if (adminParts.length > 2) {
                        const firstSeparatorStr = adminParts[1];
                        const timestampMs = parseInt(firstSeparatorStr);
                        if (!isNaN(timestampMs) && timestampMs > 1000000000000) {
                            // Restar 1 segundo a la primera respuesta para que aparezca antes
                            firstResponseTime = new Date(timestampMs - 1000);
                        }
                    }
                    
                    messages.push({
                        type: 'admin',
                        content: adminParts[0].trim(),
                        timestamp: firstResponseTime
                    });
                    
                    // Parsear el resto de respuestas con sus timestamps
                    for (let i = 1; i < adminParts.length; i += 2) {
                        if (i < adminParts.length - 1) {
                            const dateStr = adminParts[i];
                            const content = adminParts[i + 1].trim();
                            
                            // Intentar parsear como timestamp en milisegundos
                            let date;
                            const timestampMs = parseInt(dateStr);
                            if (!isNaN(timestampMs) && timestampMs > 1000000000000) {
                                // Es un timestamp v√°lido en milisegundos
                                date = new Date(timestampMs);
                            } else {
                                // Formato antiguo, parsear como fecha legible
                                date = parseDateFromString(dateStr) || new Date();
                            }
                            
                            messages.push({
                                type: 'admin',
                                content: content,
                                timestamp: date
                            });
                        }
                    }
                }
            }
            
            // Parsear respuestas del cliente
            if (ticket.client_response && ticket.client_response.trim() !== '') {
                // Primero intentar con el nuevo formato [timestamp_ms]
                let clientParts = ticket.client_response.split(/\n\n--- Respuesta adicional \[(\d+)\] ---\n\n/);
                
                // Si no hay matches con el nuevo formato, intentar con el formato antiguo (compatibilidad)
                if (clientParts.length === 1) {
                    clientParts = ticket.client_response.split(/\n\n--- Respuesta adicional \((.*?)\) ---\n\n/);
                }
                
                if (clientParts.length === 1) {
                    // Solo una respuesta del cliente
                    messages.push({
                        type: 'client',
                        content: clientParts[0].trim(),
                        timestamp: ticket.client_response_at ? new Date(ticket.client_response_at) : new Date()
                    });
                } else {
                    // M√∫ltiples respuestas del cliente
                    messages.push({
                        type: 'client',
                        content: clientParts[0].trim(),
                        timestamp: ticket.client_response_at ? new Date(ticket.client_response_at) : new Date()
                    });
                    
                    for (let i = 1; i < clientParts.length; i += 2) {
                        if (i < clientParts.length - 1) {
                            const dateStr = clientParts[i];
                            const content = clientParts[i + 1].trim();
                            
                            // Intentar parsear como timestamp en milisegundos
                            let date;
                            const timestampMs = parseInt(dateStr);
                            if (!isNaN(timestampMs) && timestampMs > 1000000000000) {
                                // Es un timestamp v√°lido en milisegundos
                                date = new Date(timestampMs);
                            } else {
                                // Formato antiguo, parsear como fecha legible
                                date = parseDateFromString(dateStr) || new Date();
                            }
                            
                            messages.push({
                                type: 'client',
                                content: content,
                                timestamp: date
                            });
                        }
                    }
                }
            }
            
            // Ordenar por timestamp
            messages.sort((a, b) => a.timestamp - b.timestamp);
            
            return messages;
        }
        
        // Funci√≥n auxiliar para parsear fechas del formato "6 oct 2025, 14:30:45"
        function parseDateFromString(dateStr) {
            try {
                // Mapeo de meses en espa√±ol
                const monthMap = {
                    'ene': 0, 'feb': 1, 'mar': 2, 'abr': 3, 'may': 4, 'jun': 5,
                    'jul': 6, 'ago': 7, 'sept': 8, 'oct': 9, 'nov': 10, 'dic': 11
                };
                
                // Formato con segundos: "6 oct 2025, 14:30:45"
                let match = dateStr.match(/(\d+)\s+(\w+)\s+(\d+),\s+(\d+):(\d+):(\d+)/);
                if (match) {
                    const day = parseInt(match[1]);
                    const month = monthMap[match[2].toLowerCase()];
                    const year = parseInt(match[3]);
                    const hours = parseInt(match[4]);
                    const minutes = parseInt(match[5]);
                    const seconds = parseInt(match[6]);
                    
                    return new Date(year, month, day, hours, minutes, seconds);
                }
                
                // Formato sin segundos (compatibilidad con mensajes antiguos): "6 oct 2025, 14:30"
                match = dateStr.match(/(\d+)\s+(\w+)\s+(\d+),\s+(\d+):(\d+)/);
                if (match) {
                    const day = parseInt(match[1]);
                    const month = monthMap[match[2].toLowerCase()];
                    const year = parseInt(match[3]);
                    const hours = parseInt(match[4]);
                    const minutes = parseInt(match[5]);
                    
                    return new Date(year, month, day, hours, minutes);
                }
            } catch (e) {
                console.error('Error parseando fecha:', dateStr, e);
            }
            return null;
        }
        
        async function viewTicket(id) {
            try {
                console.log('üé´ [ADMIN] Cargando detalles del ticket #', id);
                // Marcar como le√≠do por el admin
                const response = await fetch(`${API_URL}/api/tickets/${id}?markAsRead=admin`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const ticket = await response.json();
                console.log('üé´ [ADMIN] Ticket recibido:', ticket);
                
                const detailsDiv = document.getElementById('ticketDetails');
                
                // Badge colors
                const priorityColors = {
                    'alta': 'danger',
                    'media': 'warning',
                    'baja': 'info'
                };
                
                const statusColors = {
                    'abierto': 'warning',
                    'en_proceso': 'info',
                    'cerrado': 'success'
                };
                
                const statusText = {
                    'abierto': 'Abierto',
                    'en_proceso': 'En Proceso',
                    'cerrado': 'Cerrado'
                };
                
                detailsDiv.innerHTML = `
                    <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                        <!-- Encabezado del Ticket -->
                        <div style="padding: 20px; background: linear-gradient(135deg, #0046FE 0%, #0036C8 100%); border-radius: 12px; color: white; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0 0 5px 0; font-size: 1.3rem;">Ticket #${ticket.id}</h3>
                                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">${formatDate(ticket.created_at)}</p>
                                </div>
                                <div style="text-align: right;">
                                    <span class="badge badge-${priorityColors[ticket.priority]}" style="font-size: 0.9rem; padding: 6px 12px;">
                                        ${ticket.priority.toUpperCase()}
                                    </span>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Estado:</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1rem; font-weight: 600;">${statusText[ticket.status] || ticket.status}</p>
                                </div>
                                <div>
                                    <p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Categor√≠a:</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1rem; font-weight: 600;">${ticket.category}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del Cliente -->
                        <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üë§ Cliente</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                                <p style="margin: 0;"><strong>Nombre:</strong> ${ticket.client_name || 'N/A'}</p>
                                <p style="margin: 0;"><strong>Email:</strong> <a href="mailto:${ticket.client_email}" style="color: #0046FE;">${ticket.client_email}</a></p>
                                ${ticket.business_name ? `<p style="margin: 0; grid-column: 1/-1;"><strong>Empresa:</strong> ${ticket.business_name}</p>` : ''}
                            </div>
                        </div>
                        
                        <!-- Asunto -->
                        <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="color: #0046FE; margin: 0 0 10px 0; font-size: 1rem;">üìå Asunto</h4>
                            <p style="margin: 0; font-size: 1rem; font-weight: 600;">${ticket.subject}</p>
                        </div>
                        
                        <!-- Conversaci√≥n en orden cronol√≥gico -->
                        <div style="margin-bottom: 15px;">
                            <h4 style="color: #0046FE; margin: 0 0 15px 0; font-size: 1.1rem;">üí¨ Conversaci√≥n</h4>
                            ${parseAndSortMessages(ticket).map((message, index) => {
                                if (message.type === 'client') {
                                    return `
                                        <div style="border-left: 4px solid #0046FE; background: ${message.isInitial ? '#f8f9fa' : '#e8f4ff'}; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <span style="background: #0046FE; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;">C</span>
                                                <strong style="color: #0046FE;">${message.isInitial ? 'Mensaje Inicial del Cliente' : 'Respuesta del Cliente'}</strong>
                                            </div>
                                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; color: #333;">${message.content}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 0.75rem; color: #666;">üìÖ ${formatDate(message.timestamp)}</p>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div style="border-left: 4px solid #28a745; background: #f0f9f4; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <span style="background: #28a745; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;">A</span>
                                                <strong style="color: #28a745;">Tu Respuesta</strong>
                                            </div>
                                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; color: #333;">${message.content}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 0.75rem; color: #666;">üìÖ ${formatDate(message.timestamp)}</p>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                        
                        <!-- Formulario de Respuesta -->
                        ${ticket.status !== 'cerrado' ? `
                        <div style="border: 2px solid #0046FE; border-radius: 10px; padding: 15px;">
                            <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">‚úâÔ∏è Responder al Cliente</h4>
                            <textarea id="adminResponse" rows="4" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical;" placeholder="Escribe tu respuesta aqu√≠..."></textarea>
                            <div style="display: flex; gap: 10px; margin-top: 12px; align-items: center;">
                                <select id="ticketNewStatus" style="padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; flex: 1;">
                                    <option value="en_proceso" ${ticket.status === 'en_proceso' ? 'selected' : ''}>En Proceso</option>
                                    <option value="cerrado">Cerrado</option>
                                </select>
                                <button onclick="sendTicketResponse(${ticket.id})" class="btn-primary" style="padding: 10px 24px;">
                                    Enviar Respuesta
                                </button>
                            </div>
                        </div>
                        ` : `
                        <div style="background: #e7f5ff; border: 2px solid #0046FE; border-radius: 10px; padding: 15px; text-align: center;">
                            <p style="margin: 0; color: #0046FE; font-weight: 600;">‚úÖ Este ticket ha sido cerrado</p>
                            ${ticket.closed_at ? `<p style="margin: 5px 0 0 0; font-size: 0.85rem; color: #666;">Fecha de cierre: ${formatDate(ticket.closed_at)}</p>` : ''}
                        </div>
                        `}
                    </div>
                `;
                
                // üÜï Registrar el ticket abierto para auto-actualizaci√≥n
                currentOpenAdminTicketId = id;
                document.getElementById('ticketModal').classList.add('active');
                console.log('‚úÖ [ADMIN] Modal de ticket abierto correctamente - Auto-actualizaci√≥n activada');
                
                // üîî Recargar lista de tickets en segundo plano para actualizar badge
                loadTickets().catch(err => console.error('Error recargando tickets:', err));
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando detalles del ticket:', error);
                showNotification('Error cargando detalles del ticket', 'error');
            }
        }
        
        async function sendTicketResponse(ticketId) {
            const response = document.getElementById('adminResponse').value;
            const newStatus = document.getElementById('ticketNewStatus').value;
            
            console.log('üé´ [ADMIN] sendTicketResponse iniciado');
            console.log('üé´ [ADMIN] ticketId:', ticketId);
            console.log('üé´ [ADMIN] response:', response ? `"${response.substring(0, 50)}..."` : 'VAC√çO');
            console.log('üé´ [ADMIN] newStatus:', newStatus);
            
            if (!response || response.trim() === '') {
                showNotification('Por favor, escribe una respuesta antes de enviar.', 'warning');
                return;
            }
            
            console.log('üé´ [ADMIN] Enviando respuesta para ticket #', ticketId);
            
            const requestBody = {
                admin_response: response,
                status: newStatus
            };
            
            console.log('üé´ [ADMIN] Request body:', requestBody);
            console.log('üé´ [ADMIN] URL:', `${API_URL}/api/tickets/${ticketId}`);
            
            try {
                const res = await fetch(`${API_URL}/api/tickets/${ticketId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('üé´ [ADMIN] Response status:', res.status);
                console.log('üé´ [ADMIN] Response ok?:', res.ok);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('‚ùå [ADMIN] Error response:', errorText);
                    throw new Error(`HTTP error! status: ${res.status}, message: ${errorText}`);
                }
                
                const data = await res.json();
                console.log('‚úÖ [ADMIN] Respuesta enviada correctamente:', data);
                
                showNotification('Respuesta enviada correctamente. El cliente recibir√° un email.', 'success');
                
                // Limpiar el textarea para permitir enviar otro mensaje
                document.getElementById('adminResponse').value = '';
                
                // NO cerrar el modal para permitir conversaci√≥n continua
                // Recargar el ticket actual para mostrar la nueva respuesta
                viewTicket(ticketId);
                
                // Recargar tabla en segundo plano
                loadTickets();
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error enviando respuesta:', error);
                console.error('‚ùå [ADMIN] Error stack:', error.stack);
                showNotification('Error enviando respuesta: ' + error.message, 'error');
            }
        }

        function closeTicketModal() {
            // üÜï Limpiar el ticket abierto para detener auto-actualizaci√≥n
            currentOpenAdminTicketId = null;
            document.getElementById('ticketModal').classList.remove('active');
            console.log('‚úÖ [ADMIN] Modal cerrado - Auto-actualizaci√≥n del ticket desactivada');
            
            // üî• RECARGAR TICKETS para quitar el fondo azul del ticket le√≠do
            setTimeout(() => {
                loadTickets();
                console.log('üîÑ [ADMIN] Tickets recargados - Fondo azul eliminado del ticket le√≠do');
            }, 300); // Peque√±o delay para dar tiempo a que el backend actualice
        }

        // ===== PEDIDOS =====
        
        async function loadPedidos() {
            console.log('üöÄ [ADMIN] loadPedidos() iniciada');
            try {
                console.log('üì° [ADMIN] Fetching pedidos desde:', `${API_URL}/api/admin/submissions`);
                const response = await fetch(`${API_URL}/api/admin/submissions`);
                
                if (!response.ok) {
                    console.error('‚ùå [ADMIN] Error en respuesta:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const pedidos = await response.json();
                console.log('‚úÖ [ADMIN] Pedidos recibidos exitosamente:', pedidos.length);
                
                // Debug: Mostrar detalles del primer pedido
                if (pedidos.length > 0) {
                    const firstPedido = pedidos[0];
                    console.log('üîç [DEBUG] Primer pedido #' + firstPedido.id + ':', {
                        id: firstPedido.id,
                        business_name: firstPedido.business_name,
                        plan: firstPedido.plan,
                        previous_plan: firstPedido.previous_plan,
                        has_upgrade: firstPedido.has_upgrade,
                        is_downgrade: firstPedido.is_downgrade,
                        has_modifications: firstPedido.has_modifications
                    });
                }

                const tbody = document.getElementById('pedidosTable');
                console.log('üìã [ADMIN] Elemento tbody encontrado:', !!tbody);
                
                if (pedidos.length === 0) {
                    console.log('üì≠ [ADMIN] No hay pedidos, mostrando mensaje');
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No hay pedidos</td></tr>';
                    return;
                }

                tbody.innerHTML = pedidos.map(pedido => {
                    // Verificar si es un pedido NUEVO (nunca visto por el admin)
                    const isNewPedido = !pedido.admin_viewed_at;
                    
                    // Verificar si las modificaciones son NUEVAS (no vistas o vistas antes de la √∫ltima modificaci√≥n)
                    const hasUnviewedModifications = pedido.has_modifications && 
                        (!pedido.modifications_viewed_at || 
                         new Date(pedido.modifications_viewed_at) < new Date(pedido.last_modified_at));
                    
                    // Debug COMPLETO para TODOS los pedidos con modificaciones
                    if (pedido.has_modifications) {
                        console.log(`üì¶ [PEDIDO] ID: ${pedido.id} - ${pedido.business_name}`, {
                            has_modifications: pedido.has_modifications,
                            modifications_viewed_at: pedido.modifications_viewed_at,
                            last_modified_at: pedido.last_modified_at,
                            hasUnviewedModifications: hasUnviewedModifications,
                            comparison: {
                                viewed_is_null: !pedido.modifications_viewed_at,
                                viewed_date: pedido.modifications_viewed_at ? new Date(pedido.modifications_viewed_at).toISOString() : 'NULL',
                                modified_date: new Date(pedido.last_modified_at).toISOString(),
                                viewed_is_before_modified: pedido.modifications_viewed_at ? 
                                    new Date(pedido.modifications_viewed_at) < new Date(pedido.last_modified_at) : 
                                    'N/A (viewed is null)'
                            }
                        });
                    }
                    
                    return `
                    <tr style="${isNewPedido || hasUnviewedModifications ? 'background: #e3f2fd;' : ''}">
                        <td><strong>#${pedido.id}</strong></td>
                        <td>
                            ${pedido.business_name || 'N/A'}
                            <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                                ${pedido.has_upgrade ? '<span class="badge" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; font-size: 0.7rem; padding: 3px 8px;">üîº UPGRADE</span>' : ''}
                                ${pedido.is_downgrade ? '<span class="badge" style="background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%); color: white; font-size: 0.7rem; padding: 3px 8px;">üîΩ DOWNGRADE</span>' : ''}
                                ${hasUnviewedModifications ? '<span class="badge" style="background: #0046FE; color: white; font-size: 0.7rem; padding: 3px 8px;">‚úèÔ∏è MODIFICADO</span>' : ''}
                                ${pedido.has_modifications && !hasUnviewedModifications ? '<span class="badge" style="background: #6B7280; color: white; font-size: 0.7rem; padding: 3px 8px;">‚úÖ VISTO</span>' : ''}
                            </div>
                        </td>
                        <td>${pedido.email}</td>
                        <td>
                            <span class="badge badge-blue">${formatPlan(pedido.plan)}</span>
                            ${pedido.previous_plan ? `<br><small style="color: #999; font-size: 0.75rem;">Antes: ${formatPlan(pedido.previous_plan)}</small>` : ''}
                        </td>
                        <td><strong>${pedido.amount}‚Ç¨</strong></td>
                        <td><span class="badge badge-${pedido.status === 'paid' ? 'success' : 'warning'}">${formatStatus(pedido.status)}</span></td>
                        <td>
                            ${formatDate(pedido.created_at)}
                            ${pedido.last_modified_at ? `<br><small style="color: #666; font-size: 0.75rem;">Mod: ${formatDate(pedido.last_modified_at)}</small>` : ''}
                        </td>
                        <td><button class="btn-secondary" onclick="viewPedido(${pedido.id})">Ver</button></td>
                    </tr>
                `;
                }).join('');
                
                console.log('‚úÖ [ADMIN] Tabla de pedidos renderizada correctamente');
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando pedidos:', error);
                console.error('‚ùå [ADMIN] Stack trace:', error.stack);
                const tbody = document.getElementById('pedidosTable');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: red;">
                                <p style="margin-bottom: 10px;">‚ùå Error al cargar pedidos</p>
                                <p style="font-size: 0.9rem; color: #666;">${error.message}</p>
                                <button onclick="loadPedidos()" style="margin-top: 15px; padding: 10px 20px; background: #0046FE; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üîÑ Reintentar
                                </button>
                            </td>
                    </tr>
                    `;
                }
            }
            
            // Actualizar badges despu√©s de cargar pedidos (con peque√±o delay para asegurar que el backend termin√≥)
            setTimeout(() => {
                updateAdminBadges();
            }, 500);
        }

        async function viewPedido(id) {
            try {
                console.log('üëÅÔ∏è [ADMIN] Ver pedido #' + id + ' clickeado');
                console.log('üìã [ADMIN] Estado ANTES de marcar como visto - Timestamp actual:', new Date().toISOString());
                
                // Marcar como visto antes de redirigir
                const response = await fetch(`${API_URL}/api/admin/submissions/${id}/mark-viewed`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                console.log('‚úÖ [ADMIN] Respuesta del servidor al marcar como visto:', {
                    success: result.success,
                    timestamp: result.timestamp,
                    response_status: response.status
                });
                
                if (!response.ok) {
                    console.error('‚ùå [ADMIN] Error en respuesta del servidor:', response.status, result);
                }
                
                // Guardar el timestamp en localStorage para recargar al volver
                const viewedTimestamp = Date.now();
                localStorage.setItem('pedidoViewed', viewedTimestamp.toString());
                console.log('üíæ [ADMIN] Guardando pedidoViewed en localStorage:', viewedTimestamp);
                console.log('üíæ [ADMIN] localStorage.pedidoViewed confirmado:', localStorage.getItem('pedidoViewed'));
                
                // Redirigir a la p√°gina de detalles
                console.log('üîÄ [ADMIN] Redirigiendo a pedido-detalle.html?id=' + id);
                window.location.href = `https://admin.agutidesigns.es/pedido-detalle.html?id=${id}`;
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error marcando como visto:', error);
                console.error('‚ùå [ADMIN] Stack trace:', error.stack);
                // Redirigir de todas formas
                window.location.href = `https://admin.agutidesigns.es/pedido-detalle.html?id=${id}`;
            }
        }

        async function viewPedidoOLD(id) {
            try {
                console.log('üìã [ADMIN] Cargando detalles del pedido #', id);
                const response = await fetch(`${API_URL}/api/admin/submissions/${id}`);
                const pedido = await response.json();
                
                console.log('üìã [ADMIN] Pedido recibido:', pedido);
                console.log('üìã [ADMIN] Logo URL:', pedido.logo_url);
                console.log('üìã [ADMIN] Additional images:', pedido.additional_images);
                
                const detailsDiv = document.getElementById('pedidoDetails');
                
                // Parsear arrays/objetos JSON
                const pages = pedido.pages ? (typeof pedido.pages === 'string' ? JSON.parse(pedido.pages) : pedido.pages) : [];
                const purpose = pedido.purpose ? (typeof pedido.purpose === 'string' ? JSON.parse(pedido.purpose) : pedido.purpose) : [];
                const contactMethods = pedido.contact_methods ? (typeof pedido.contact_methods === 'string' ? JSON.parse(pedido.contact_methods) : pedido.contact_methods) : [];
                
                detailsDiv.innerHTML = `
                    <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                        <!-- Header con Plan Contratado y Bot√≥n -->
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 20px;">
                            <div style="flex: 1; padding: 20px; background: linear-gradient(135deg, #0046FE 0%, #0036C8 100%); border-radius: 12px; color: white;">
                                <h3 style="margin: 0 0 15px 0; font-size: 1.3rem;">
                                    Plan Contratado
                                    ${pedido.is_upgrade ? '<span style="background: rgba(255, 107, 53, 0.9); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; margin-left: 10px;">üîº UPGRADE</span>' : ''}
                                    ${pedido.is_downgrade ? '<span style="background: rgba(147, 51, 234, 0.9); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; margin-left: 10px;">üîΩ DOWNGRADE</span>' : ''}
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div>
                                        <p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Plan:</p>
                                        <p style="margin: 5px 0 0 0; font-size: 1.2rem; font-weight: 700;">${formatPlan(pedido.plan)}</p>
                                        ${pedido.previous_plan ? `<p style="margin: 5px 0 0 0; font-size: 0.75rem; opacity: 0.8;">Anterior: ${formatPlan(pedido.previous_plan)}</p>` : ''}
                                    </div>
                                    <div><p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Monto:</p><p style="margin: 5px 0 0 0; font-size: 1.2rem; font-weight: 700;">${pedido.amount}‚Ç¨</p></div>
                                    <div><p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Estado:</p><p style="margin: 5px 0 0 0;">${formatStatus(pedido.status)}</p></div>
                                    <div><p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Fecha:</p><p style="margin: 5px 0 0 0;">${formatDate(pedido.created_at)}</p></div>
                                </div>
                            </div>
                            <button 
                                onclick="window.open('/client-dashboard/?email=${encodeURIComponent(pedido.email)}', '_blank')"
                                style="padding: 15px 20px; background: white; border: 2px solid #0046FE; color: #0046FE; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; white-space: nowrap; transition: all 0.3s ease;">
                                üëÅÔ∏è Ver Dashboard<br>del Cliente
                            </button>
                        </div>
                        
                        <!-- Grid de 2 columnas para el resto -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            
                            <!-- Datos del Negocio -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üè¢ Datos del Negocio</h4>
                                <div style="font-size: 0.85rem; line-height: 1.6;">
                                    <p style="margin: 5px 0;"><strong>Nombre:</strong> ${pedido.business_name || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Industria:</strong> ${pedido.industry || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Descripci√≥n:</strong> ${pedido.business_description || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Datos del Cliente -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üë§ Datos del Cliente</h4>
                                <div style="font-size: 0.85rem; line-height: 1.6;">
                                    <p style="margin: 5px 0;"><strong>Nombre:</strong> ${pedido.full_name || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Email:</strong> ${pedido.email || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Tel√©fono:</strong> ${pedido.phone || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Contacto -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üìû Contacto Web</h4>
                                <div style="font-size: 0.85rem; line-height: 1.6;">
                                    <p style="margin: 5px 0;"><strong>M√©todos de Contacto:</strong> ${contactMethods.join(', ') || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Email Web:</strong> ${pedido.email_contact || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Email Formulario:</strong> ${pedido.form_email || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Tel√©fono:</strong> ${pedido.phone_number || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>WhatsApp:</strong> ${pedido.whatsapp_number || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Direcci√≥n F√≠sica:</strong> ${pedido.physical_address || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Redes Sociales -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üì± Redes Sociales</h4>
                                <div style="font-size: 0.85rem; line-height: 1.6;">
                                    <p style="margin: 5px 0;"><strong>Instagram:</strong> ${pedido.instagram || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Facebook:</strong> ${pedido.facebook || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>LinkedIn:</strong> ${pedido.linkedin || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Twitter:</strong> ${pedido.twitter || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Servicios -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; grid-column: 1/-1;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üíº Servicios</h4>
                                <p style="font-size: 0.85rem; margin: 0; line-height: 1.6;">${pedido.services || 'N/A'}</p>
                            </div>
                            
                            <!-- P√°ginas -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üìÑ P√°ginas</h4>
                                <div style="font-size: 0.85rem;">
                                    ${pages.length > 0 ? pages.map(p => `<div style="padding: 5px; background: #f8f9fa; margin-bottom: 3px; border-radius: 5px;">‚úì ${p}</div>`).join('') : '<p>No especificadas</p>'}
                                </div>
                            </div>
                            
                            <!-- Objetivos -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üéØ Objetivos</h4>
                                <div style="font-size: 0.85rem; line-height: 1.6;">
                                    <p style="margin: 5px 0;"><strong>Prop√≥sito:</strong> ${purpose.join(', ') || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>P√∫blico:</strong> ${pedido.target_audience || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Dise√±o -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üé® Dise√±o</h4>
                                <div style="font-size: 0.85rem; line-height: 1.6;">
                                    <p style="margin: 5px 0;"><strong>Estilo:</strong> ${pedido.design_style || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Colores:</strong> ${pedido.brand_colors || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Referencias:</strong> ${pedido.reference_websites || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- SEO y Dominio -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; grid-column: 1/-1;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üîç SEO y Dominio</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.85rem;">
                                    <p style="margin: 0;"><strong>Dominio Preferido:</strong> ${pedido.domain_name || 'N/A'}</p>
                                    <p style="margin: 0;"><strong>Dominio Alt 1:</strong> ${pedido.domain_alt1 || 'N/A'}</p>
                                    <p style="margin: 0;"><strong>Dominio Alt 2:</strong> ${pedido.domain_alt2 || 'N/A'}</p>
                                    <p style="margin: 0;"><strong>Google Analytics:</strong> ${pedido.has_analytics === 'yes' ? 'S√≠' : (pedido.has_analytics === 'no' ? 'No' : 'N/A')}</p>
                                    <p style="margin: 0; grid-column: 1/-1;"><strong>Palabras Clave SEO:</strong> ${pedido.keywords || 'N/A'}</p>
                                </div>
                            </div>
                            
                            ${pedido.web_texts ? `
                            <!-- Textos Personalizados -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; grid-column: 1/-1;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üìù Textos Personalizados</h4>
                                <p style="font-size: 0.85rem; margin: 0; line-height: 1.6; white-space: pre-wrap; background: #f8f9fa; padding: 12px; border-radius: 6px;">${pedido.web_texts}</p>
                            </div>
                            ` : ''}
                            
                            ${pedido.menu_content || pedido.opening_hours || pedido.portfolio_description ? `
                            <!-- Campos Din√°micos por Sector -->
                            <div style="border: 2px solid #009A62; border-radius: 10px; padding: 15px; grid-column: 1/-1; background: rgba(0, 154, 98, 0.02);">
                                <h4 style="color: #009A62; margin: 0 0 15px 0; font-size: 1.1rem;">üçΩÔ∏è Informaci√≥n Espec√≠fica del Sector</h4>
                                <div style="display: grid; gap: 15px;">
                                    ${pedido.menu_content ? `
                                        <div style="border: 1px solid #009A62; border-radius: 8px; padding: 12px; background: white;">
                                            <p style="margin: 0 0 8px 0; font-weight: 700; color: #009A62; font-size: 0.9rem;">üìã Men√∫ (Restaurante/Bar/Cafeter√≠a)</p>
                                            <p style="font-size: 0.85rem; margin: 0; line-height: 1.6; white-space: pre-wrap; background: #f8fef8; padding: 10px; border-radius: 5px;">${pedido.menu_content}</p>
                                        </div>
                                    ` : ''}
                                    ${pedido.opening_hours ? `
                                        <div style="border: 1px solid #009A62; border-radius: 8px; padding: 12px; background: white;">
                                            <p style="margin: 0 0 8px 0; font-weight: 700; color: #009A62; font-size: 0.9rem;">üïê Horarios de Apertura</p>
                                            <p style="font-size: 0.85rem; margin: 0; line-height: 1.6; white-space: pre-wrap; background: #f8fef8; padding: 10px; border-radius: 5px;">${pedido.opening_hours}</p>
                                        </div>
                                    ` : ''}
                                    ${pedido.portfolio_description ? `
                                        <div style="border: 1px solid #009A62; border-radius: 8px; padding: 12px; background: white;">
                                            <p style="margin: 0 0 8px 0; font-weight: 700; color: #009A62; font-size: 0.9rem;">üì∏ Descripci√≥n de Portfolio/Proyectos</p>
                                            <p style="font-size: 0.85rem; margin: 0; line-height: 1.6; white-space: pre-wrap; background: #f8fef8; padding: 10px; border-radius: 5px;">${pedido.portfolio_description}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Fiscal -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; grid-column: 1/-1;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">‚öñÔ∏è Datos Fiscales</h4>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85rem;">
                                    <p style="margin: 0;"><strong>CIF/NIF:</strong> ${pedido.cif_nif || 'N/A'}</p>
                                    <p style="margin: 0;"><strong>Raz√≥n Social:</strong> ${pedido.razon_social || 'N/A'}</p>
                                    <p style="margin: 0; grid-column: 1/-1;"><strong>Direcci√≥n:</strong> ${pedido.direccion_fiscal || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Archivos e Im√°genes -->
                            <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; grid-column: 1/-1;">
                                <h4 style="color: #0046FE; margin: 0 0 12px 0; font-size: 1rem;">üñºÔ∏è Logo e Im√°genes</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                    ${pedido.logo_data ? `
                                        <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; text-align: center;">
                                            <p style="margin: 0 0 10px 0; font-weight: 600; font-size: 0.85rem; color: #666;">Logo</p>
                                            <img src="${pedido.logo_data}" alt="Logo" style="max-width: 100%; height: 150px; object-fit: contain; border-radius: 5px; background: #f5f5f5; padding: 10px;">
                                            <a href="${pedido.logo_data}" download="logo.png" style="display: inline-block; margin-top: 8px; color: #0046FE; text-decoration: none; font-size: 0.8rem;">üíæ Descargar</a>
                                            <a href="${pedido.logo_data}" target="_blank" style="display: inline-block; margin-top: 8px; margin-left: 8px; color: #0046FE; text-decoration: none; font-size: 0.8rem;">üîç Ver</a>
                                        </div>
                                    ` : '<p style="color: #999; font-size: 0.9rem;">No se subi√≥ logo</p>'}
                                    
                                    ${pedido.images_data ? (() => {
                                        const images = typeof pedido.images_data === 'string' ? JSON.parse(pedido.images_data) : pedido.images_data;
                                        if (Array.isArray(images) && images.length > 0) {
                                            return images.map((img, index) => `
                                                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; text-align: center;">
                                                    <p style="margin: 0 0 10px 0; font-weight: 600; font-size: 0.85rem; color: #666;">Imagen ${index + 1}</p>
                                                    <img src="${img}" alt="Imagen ${index + 1}" style="max-width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
                                                    <a href="${img}" download="imagen-${index + 1}.png" style="display: inline-block; margin-top: 8px; color: #0046FE; text-decoration: none; font-size: 0.8rem;">üíæ Descargar</a>
                                                    <a href="${img}" target="_blank" style="display: inline-block; margin-top: 8px; margin-left: 8px; color: #0046FE; text-decoration: none; font-size: 0.8rem;">üîç Ver</a>
                                                </div>
                `).join('');
                                        }
                                        return '<p style="color: #999; font-size: 0.9rem; grid-column: 1/-1;">No se subieron im√°genes adicionales</p>';
                                    })() : ''}
                                </div>
                            </div>
                            
                        </div>
                    </div>
                `;
                
                document.getElementById('pedidoModal').classList.add('active');
                console.log('‚úÖ [ADMIN] Modal de pedido abierto correctamente');
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando detalles del pedido:', error);
                showNotification('Error cargando detalles del pedido', 'error');
            }
        }

        function closePedidoModal() {
            document.getElementById('pedidoModal').classList.remove('active');
        }

        // ===== CLIENTES =====
        async function loadClientes() {
            try {
                console.log('üë• [ADMIN] Cargando clientes...');
                console.log('üë• [ADMIN] URL:', `${API_URL}/api/clients`);
                
                const response = await fetch(`${API_URL}/api/clients`);
                console.log('üë• [ADMIN] Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const clientes = await response.json();
                
                console.log('üë• [ADMIN] Clientes recibidos:', clientes.length, 'clientes');
                console.log('üë• [ADMIN] Datos completos:', clientes);

                const tbody = document.getElementById('clientesTable');
                console.log('üë• [ADMIN] Tbody encontrado:', !!tbody);
                
                if (clientes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No hay clientes</td></tr>';
                    console.warn('‚ö†Ô∏è [ADMIN] No hay clientes en la base de datos');
                    return;
                }

                const html = clientes.map((client, index) => {
                    console.log(`üë• [ADMIN] Cliente ${index + 1}:`, {
                        id: client.id,
                        name: client.full_name,
                        email: client.email,
                        business: client.business_name,
                        plan: client.plan,
                        created_at: client.created_at
                    });
                    
                    return `
                    <tr>
                        <td><strong>#${client.id}</strong></td>
                        <td>${client.full_name || 'N/A'}</td>
                        <td>${client.email}</td>
                        <td>${client.business_name || 'N/A'}</td>
                        <td><span class="badge badge-blue">${client.plan || 'Sin plan'}</span></td>
                        <td><span class="badge badge-${client.plan ? 'success' : 'warning'}">${client.plan ? 'Activo' : 'Inactivo'}</span></td>
                        <td>${formatDate(client.created_at)}</td>
                        <td><button class="btn-secondary" onclick="viewClient(${client.id})">Ver</button></td>
                    </tr>
                `;
                }).join('');
                
                console.log('üë• [ADMIN] HTML generado (primeros 200 caracteres):', html.substring(0, 200));
                tbody.innerHTML = html;
                console.log('‚úÖ [ADMIN] Tabla de clientes actualizada correctamente');
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando clientes:', error);
                showNotification('Error al cargar clientes: ' + error.message, 'error');
            }
        }

        async function viewClient(id) {
            try {
                console.log(`üëÅÔ∏è [ADMIN] Cargando detalles del cliente #${id}`);
                
                // Si estamos en la secci√≥n de cancelaciones, marcar como visto
                const currentSection = document.querySelector('.section.active');
                if (currentSection && currentSection.id === 'section-cancelaciones') {
                    console.log('üö´ [ADMIN] Viendo cliente desde Cancelaciones, marcando como vista...');
                    try {
                        await fetch(`${API_URL}/api/admin/mark-cancellation-viewed/${id}`, {
                            method: 'POST'
                        });
                        console.log('‚úÖ [ADMIN] Cancelaci√≥n marcada como vista');
                    } catch (error) {
                        console.error('‚ùå [ADMIN] Error marcando cancelaci√≥n como vista:', error);
                    }
                }
                
                // Mostrar modal con loader
                const modal = document.createElement('div');
                modal.id = 'clientDetailModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 40px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative;">
                        <div class="loader">
                            <div class="spinner"></div>
                            <p>Cargando datos del cliente...</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Cerrar modal al hacer clic fuera
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeClientModal();
                    }
                };
                
                // Obtener detalles del cliente
                const response = await fetch(`${API_URL}/api/clients/${id}`);
                const client = await response.json();
                
                console.log('üëÅÔ∏è [ADMIN] Datos del cliente:', client);
                
                // Renderizar contenido del modal
                const content = modal.querySelector('div');
                content.innerHTML = `
                    <button onclick="closeClientModal()" 
                            style="position: absolute; top: 20px; right: 20px; background: #f0f0f0; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;">
                        ‚úï
                    </button>
                    
                    <h2 style="color: #0046FE; margin-bottom: 10px;">üë§ Cliente #${client.id}</h2>
                    <p style="color: #666; margin-bottom: 30px;">${client.full_name}</p>
                    
                    <!-- Datos b√°sicos -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #1B1B1B;">üìã Informaci√≥n B√°sica</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <strong>Email:</strong><br>
                                <span style="color: #666;">${client.email}</span>
                            </div>
                            <div>
                                <strong>Plan:</strong><br>
                                <span class="badge badge-blue">${client.plan || 'Sin plan'}</span>
                            </div>
                            <div>
                                <strong>Estado Web:</strong><br>
                                <span class="badge badge-${client.website_status === 'activo' ? 'success' : 'warning'}">${client.website_status || 'N/A'}</span>
                            </div>
                            <div>
                                <strong>Fecha de pago:</strong><br>
                                <span style="color: #666;">${client.payment_date ? formatDate(client.payment_date) : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${client.submission ? `
                        <!-- Datos del negocio -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #1B1B1B;">üè¢ Datos del Negocio</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>Empresa:</strong><br>
                                    <span style="color: #666;">${client.submission.business_name || 'N/A'}</span>
                                </div>
                                <div>
                                    <strong>Sector:</strong><br>
                                    <span style="color: #666;">${client.submission.industry || 'N/A'}</span>
                                </div>
                                <div>
                                    <strong>Dominio:</strong><br>
                                    <span style="color: #666;">${client.submission.domain_name || 'N/A'}</span>
                                </div>
                                <div>
                                    <strong>Tel√©fono:</strong><br>
                                    <span style="color: #666;">${client.submission.phone_number || 'N/A'}</span>
                                </div>
                            </div>
                            
                            ${client.submission.business_description ? `
                                <div style="margin-top: 15px;">
                                    <strong>Descripci√≥n:</strong><br>
                                    <p style="color: #666; margin-top: 5px;">${client.submission.business_description}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Redes Sociales -->
                        ${(client.submission.instagram || client.submission.facebook || client.submission.linkedin) ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px; color: #1B1B1B;">üì± Redes Sociales</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    ${client.submission.instagram ? `<div><strong>Instagram:</strong><br><a href="https://instagram.com/${client.submission.instagram}" target="_blank" style="color: #0046FE;">@${client.submission.instagram}</a></div>` : ''}
                                    ${client.submission.facebook ? `<div><strong>Facebook:</strong><br><a href="${client.submission.facebook}" target="_blank" style="color: #0046FE;">${client.submission.facebook}</a></div>` : ''}
                                    ${client.submission.linkedin ? `<div><strong>LinkedIn:</strong><br><a href="${client.submission.linkedin}" target="_blank" style="color: #0046FE;">${client.submission.linkedin}</a></div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    ` : '<p style="color: #999; text-align: center; padding: 20px;">No hay datos de formulario disponibles</p>'}
                    
                    ${client.project ? `
                        <!-- Datos del proyecto -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #1B1B1B;">üåê Proyecto Web</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>Nombre:</strong><br>
                                    <span style="color: #666;">${client.project.project_name || client.project.business_name}</span>
                                </div>
                                <div>
                                    <strong>Estado:</strong><br>
                                    <span class="badge badge-${client.project.status === 'entregada' ? 'success' : 'warning'}">${client.project.status}</span>
                                </div>
                                <div>
                                    <strong>Progreso:</strong><br>
                                    <span style="color: #666;">${client.project.progress || 0}%</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Acciones -->
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button onclick="closeClientModal(); showSection('webs', event)" class="btn-primary">
                            Ver en Kanban
                        </button>
                        ${client.submission ? `
                            <button onclick="closeClientModal(); viewPedido(${client.submission.id})" class="btn-secondary">
                                Ver Pedido Completo
                            </button>
                        ` : ''}
                        <button onclick="closeClientModal()" class="btn-secondary" style="background: #999;">
                            Cerrar
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando cliente:', error);
                showNotification('Error cargando datos del cliente', 'error');
                document.getElementById('clientDetailModal')?.remove();
            }
        }
        
        // Funci√≥n helper para cerrar modal de cliente y actualizar badges
        function closeClientModal() {
            document.getElementById('clientDetailModal')?.remove();
            
            // Si estamos en la secci√≥n de cancelaciones, recargar la tabla para quitar el fondo azul
            const currentSection = document.querySelector('.section.active');
            if (currentSection && currentSection.id === 'section-cancelaciones') {
                console.log('üîÑ [ADMIN] Recargando cancelaciones para actualizar vista...');
                setTimeout(() => {
                    loadCancellations();
                }, 300); // Peque√±o delay para dar tiempo a que el backend actualice
            }
            
            // Actualizar badges
            updateAdminBadges();
        }

        // üÜï Funci√≥n para arreglar submissions de clientes existentes
        async function fixClientSubmissions() {
            if (!confirm('¬øQuieres vincular las submissions a los clientes que no tienen submission_id?\n\nEsto buscar√° submissions por email y las vincular√° autom√°ticamente.')) {
                return;
            }
            
            try {
                showNotification('üîß Corrigiendo submissions...', 'info');
                
                const response = await fetch(`${API_URL}/api/admin/fix-client-submissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Correcci√≥n completada:\n- ${result.fixed} clientes corregidos\n- ${result.notFound} sin submission\n- ${result.total} total`, 'success');
                    loadClientes(); // Recargar lista
                } else {
                    showNotification('Error en la correcci√≥n', 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al corregir submissions', 'error');
            }
        }

        // ===== VIDEOS =====
        let allVideos = []; // Cache para edici√≥n
        
        async function loadVideos() {
            const videosGrid = document.getElementById('videosGrid');
            
            try {
                const response = await fetch(`${API_URL}/api/videos`);
                let videos = await response.json();
                
                // Guardar en cache
                allVideos = videos;
                
                // Ordenar videos por display_order
                videos.sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
                
                if (videos.length === 0) {
                    videosGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">
                            <p style="font-size: 1.2rem; margin-bottom: 10px;">üìπ No hay videos todav√≠a</p>
                            <p style="color: #aaa;">A√±ade tu primer video tutorial para los clientes</p>
                            <button class="btn-primary" onclick="openNewVideoModal()" style="margin-top: 15px;">+ A√±adir tu primer video</button>
                        </div>
                    `;
                    return;
                }
                
                videosGrid.innerHTML = videos.map(video => `
                    <div class="video-card" style="background: white; border: 1px solid #e8eaed; border-radius: 12px; overflow: hidden; position: relative;">
                        <!-- Badge de orden -->
                        <div style="position: absolute; top: 10px; left: 10px; background: linear-gradient(135deg, #0046FE, #0056FF); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(0, 70, 254, 0.4); z-index: 10;">
                            ${video.display_order || '?'}
                        </div>
                        <div style="position: relative; padding-top: 56.25%; background: #f0f0f0;">
                            ${video.thumbnail_url 
                                ? `<img src="${video.thumbnail_url}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'">`
                                : `<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem;">‚ñ∂Ô∏è</div>`
                            }
                        </div>
                        <div style="padding: 15px;">
                            <h3 style="margin: 0 0 8px 0; font-size: 1rem; color: #1B1B1B;">${video.title}</h3>
                            <p style="margin: 0 0 10px 0; font-size: 0.85rem; color: #666; line-height: 1.4;">${video.description || ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                <span style="font-size: 0.8rem; color: #999;">‚è± ${video.duration || 'N/A'}</span>
                                <span style="font-size: 0.75rem; padding: 4px 10px; background: #e8f4ff; color: #0046FE; border-radius: 12px; font-weight: 600;">${getCategoryLabel(video.category)}</span>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                                <button onclick="window.open('${video.url}', '_blank')" style="flex: 1; padding: 8px; background: #0046FE; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">Ver Video</button>
                                <button onclick="editVideo(${video.id})" style="padding: 8px 12px; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">‚úèÔ∏è</button>
                                <button onclick="deleteVideo(${video.id})" style="padding: 8px 12px; background: #ff4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error cargando videos:', error);
                videosGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ff4444;">
                        <p>Error al cargar videos</p>
                        <button class="btn-primary" onclick="loadVideos()" style="margin-top: 15px;">Reintentar</button>
                    </div>
                `;
            }
        }
        
        function getCategoryLabel(category) {
            const labels = {
                'tutorial_elementor': 'Tutorial Elementor',
                'seo': 'SEO',
                'marketing': 'Marketing',
                'basico': 'B√°sico',
                'avanzado': 'Avanzado'
            };
            return labels[category] || category;
        }
        
        async function deleteVideo(videoId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este video?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/admin/videos/${videoId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Video eliminado correctamente', 'success');
                    loadVideos();
                } else {
                    showNotification('Error al eliminar video', 'error');
                }
            } catch (error) {
                console.error('Error eliminando video:', error);
                showNotification('Error al eliminar video', 'error');
            }
        }

        function editVideo(videoId) {
            // Buscar el video en el cache
            const video = allVideos.find(v => v.id === videoId);
            if (!video) {
                showNotification('Video no encontrado', 'error');
                return;
            }
            
            // Cambiar t√≠tulo del modal
            document.getElementById('videoModalTitle').textContent = '‚úèÔ∏è Editar Video';
            
            // Rellenar el formulario con los datos del video
            document.getElementById('videoId').value = video.id;
            document.getElementById('videoTitle').value = video.title || '';
            document.getElementById('videoDescription').value = video.description || '';
            document.getElementById('videoUrl').value = video.url || '';
            document.getElementById('videoCategory').value = video.category || 'tutorial_elementor';
            document.getElementById('videoDuration').value = video.duration || '';
            document.getElementById('videoOrder').value = video.display_order || 1;
            
            // Abrir modal
            document.getElementById('videoModal').classList.add('active');
        }

        function openNewVideoModal() {
            // Resetear t√≠tulo
            document.getElementById('videoModalTitle').textContent = 'üé• A√±adir Video';
            document.getElementById('videoModal').classList.add('active');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.remove('active');
            document.getElementById('videoForm').reset();
            document.getElementById('videoId').value = '';
            document.getElementById('videoModalTitle').textContent = 'üé• A√±adir Video';
        }

        document.getElementById('videoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const videoId = document.getElementById('videoId').value;
            const isEditing = videoId !== '';
            
            const videoData = {
                title: document.getElementById('videoTitle').value,
                description: document.getElementById('videoDescription').value,
                url: document.getElementById('videoUrl').value,
                category: document.getElementById('videoCategory').value,
                duration: document.getElementById('videoDuration').value,
                display_order: parseInt(document.getElementById('videoOrder').value) || 1,
                thumbnail_url: extractThumbnail(document.getElementById('videoUrl').value)
            };
            
            try {
                const url = isEditing 
                    ? `${API_URL}/api/admin/videos/${videoId}` 
                    : `${API_URL}/api/admin/videos`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(videoData)
                });
                
                if (response.ok) {
                    const message = isEditing ? 'Video actualizado correctamente' : 'Video a√±adido correctamente';
                    showNotification(message, 'success');
                    closeVideoModal();
                    loadVideos(); // Recargar lista
                } else {
                    const error = await response.json();
                    showNotification('Error al guardar video: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Error guardando video:', error);
                showNotification('Error al guardar video', 'error');
            }
        });
        
        // Funci√≥n para extraer thumbnail de YouTube/Vimeo
        function extractThumbnail(url) {
            // YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = url.includes('youtu.be') 
                    ? url.split('youtu.be/')[1]?.split('?')[0]
                    : url.split('v=')[1]?.split('&')[0];
                return `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            }
            // Vimeo
            if (url.includes('vimeo.com')) {
                const videoId = url.split('vimeo.com/')[1]?.split('?')[0];
                return `https://vumbnail.com/${videoId}.jpg`;
            }
            return null;
        }

        // ===== WEBS DESPLEGADAS =====
        let allWebsData = []; // Cache para filtrado r√°pido

        async function loadWebsDesplegadas() {
            try {
                console.log('üåê [ADMIN] Cargando webs desplegadas...');
                
                // Obtenemos todos los clientes
                const response = await fetch(`${API_URL}/api/clients`);
                const clients = await response.json();
                
                console.log('üìä [ADMIN] Total de clientes:', clients.length);
                
                // Filtramos solo los que tienen un plan activo (pagaron)
                allWebsData = clients.filter(client => {
                    const hasPlan = client.plan && client.plan !== 'sin_plan';
                    if (hasPlan) {
                        console.log('‚úÖ Cliente con plan:', client.email, '- Plan:', client.plan, '- WordPress:', client.wordpress_url || 'No configurado');
                    }
                    return hasPlan;
                });
                
                console.log('üéØ [ADMIN] Clientes con plan para gestionar:', allWebsData.length);
                
                renderWebsGrid(allWebsData);
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando webs:', error);
                document.getElementById('websGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">
                        <p>Error cargando sitios web</p>
                    </div>
                `;
            }
        }

        function renderWebsGrid(webs) {
            const websGrid = document.getElementById('websGrid');
            const counter = document.getElementById('websCounter');
            
            counter.textContent = webs.length;
            
            if (webs.length === 0) {
                websGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üåê</div>
                        <h3 style="color: #666; margin-bottom: 10px;">No hay sitios web desplegados</h3>
                        <p>Los sitios aparecer√°n aqu√≠ cuando los proyectos sean entregados</p>
                    </div>
                `;
                return;
            }
            
            websGrid.innerHTML = webs.map(web => {
                // Si est√° cancelado, mostrar estado especial
                const isCancelled = web.subscription_status === 'cancelled';
                const statusClass = isCancelled ? 'web-status-cancelled' : `web-status-${web.website_status || 'en_construccion'}`;
                const statusEmoji = isCancelled ? 'üö´' : (web.website_status === 'activo' ? '‚úÖ' : (web.website_status === 'mantenimiento' ? 'üîß' : 'üî®'));
                const statusText = isCancelled ? 'Cancelado' : (web.website_status === 'activo' ? 'Activo' : (web.website_status === 'mantenimiento' ? 'Mantenimiento' : 'En Construcci√≥n'));
                
                const planClass = `plan-${web.plan || 'basico'}`;
                const planText = formatPlan(web.plan);
                
                // Extraer dominio limpio de la URL o mostrar empresa
                let displayDomain = web.business_name || web.full_name || 'Sin nombre';
                let displayUrl = web.website_url || 'Pendiente de configuraci√≥n';
                
                if (web.website_url) {
                    try {
                        const url = new URL(web.website_url);
                        displayDomain = url.hostname.replace('www.', '');
                    } catch (e) {
                        displayDomain = web.website_url;
                    }
                }
                
                return `
                    <div class="web-card" data-client-id="${web.id}" ${isCancelled ? 'style="border: 3px solid #dc2626; box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);"' : ''}>
                        ${isCancelled ? `
                            <div style="position: absolute; top: -15px; right: 20px; background: #dc2626; color: white; padding: 8px 20px; border-radius: 25px; font-weight: 700; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4); z-index: 10;">
                                üö´ INACTIVO / CANCELADO
                            </div>
                        ` : ''}
                        <!-- Screenshot de la Web -->
                        <div class="web-screenshot" ${web.website_url ? `onclick="window.open('${web.website_url}', '_blank')" style="cursor: pointer;"` : 'style="cursor: default;"'}>
                            ${web.website_screenshot_url ? `
                                <img src="${web.website_screenshot_url}" alt="Screenshot de ${displayDomain}" style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px 8px 0 0;">
                            ` : `
                                <div style="width: 100%; height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px 8px 0 0; color: white;">
                                    <div style="font-size: 3rem; margin-bottom: 10px;">üåê</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">${statusText}</div>
                                </div>
                            `}
                        </div>
                        
                        <div class="web-card-header">
                            <div class="web-domain">
                                <h3 title="${displayDomain}">${displayDomain}</h3>
                                ${web.website_url ? `
                                    <a href="${web.website_url}" target="_blank" class="web-url">
                                        ${web.website_url} üîó
                                    </a>
                                ` : `
                                    <span class="web-url" style="color: #999; cursor: default;">
                                        ${displayUrl}
                                    </span>
                                `}
                            </div>
                            <div class="web-status-badge ${statusClass}">
                                ${statusEmoji} ${statusText}
                            </div>
                        </div>
                        
                        <div class="web-card-info">
                            <div class="web-info-row">
                                <span class="web-info-label">Cliente:</span>
                                <span class="web-info-value">${web.full_name || 'N/A'}</span>
                            </div>
                            <div class="web-info-row">
                                <span class="web-info-label">Empresa:</span>
                                <span class="web-info-value">${web.business_name || 'N/A'}</span>
                            </div>
                            <div class="web-info-row">
                                <span class="web-info-label">Plan:</span>
                                <span class="web-plan-badge ${planClass}">${planText}</span>
                            </div>
                            <div class="web-info-row">
                                <span class="web-info-label">WordPress:</span>
                                <span class="web-info-value" style="font-size: 0.85rem;">${web.wordpress_url ? '‚úÖ Configurado' : '‚ö†Ô∏è Pendiente'}</span>
                            </div>
                        </div>
                        
                        <div class="web-card-actions">
                            ${(web.website_url || web.wordpress_url) ? `
                                <button class="btn-web-action btn-web-visit" onclick="window.open('${web.website_url || web.wordpress_url}', '_blank')">
                                    üåê Visitar
                                </button>
                            ` : `
                                <button class="btn-web-action" style="opacity: 0.5; cursor: not-allowed;" disabled title="A√±ade la URL en Gestionar">
                                    üåê Visitar
                                </button>
                            `}
                            ${web.wordpress_url ? `
                                <button class="btn-web-action" style="background: #21759b;" onclick="window.open('${web.wordpress_url}', '_blank')">
                                    ‚úèÔ∏è WordPress
                                </button>
                            ` : ''}
                            <button class="btn-web-action btn-web-details" onclick="editWebManagement(${web.id})" style="background: #0046FE;">
                                ‚öôÔ∏è Gestionar
                            </button>
                            ${web.website_status === 'en_construccion' && web.subscription_status !== 'cancelled' ? `
                                <button class="btn-web-action" onclick="activateWebsite(${web.id}, '${web.full_name}', '${web.business_name}')" style="background: #10B981; font-weight: 600;">
                                    üöÄ Activar Web
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filtros y b√∫squeda
        function filterWebs() {
            const searchTerm = document.getElementById('searchWebsInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatusWebs').value;
            const planFilter = document.getElementById('filterPlanWebs').value;
            
            let filtered = allWebsData.filter(web => {
                // B√∫squeda por texto
                const matchesSearch = !searchTerm || 
                    (web.website_url && web.website_url.toLowerCase().includes(searchTerm)) ||
                    (web.full_name && web.full_name.toLowerCase().includes(searchTerm)) ||
                    (web.business_name && web.business_name.toLowerCase().includes(searchTerm)) ||
                    (web.email && web.email.toLowerCase().includes(searchTerm));
                
                // Filtro por estado (las canceladas se consideran "inactivo")
                let matchesStatus = true;
                if (statusFilter) {
                    if (statusFilter === 'inactivo') {
                        // Incluir tanto las inactivas como las canceladas
                        matchesStatus = web.subscription_status === 'cancelled' || 
                                       web.website_status === 'inactivo' || 
                                       web.website_status === 'en_construccion';
                    } else {
                        // Para "activo" solo mostrar las activas que NO est√°n canceladas
                        matchesStatus = web.website_status === statusFilter && 
                                       web.subscription_status !== 'cancelled';
                    }
                }
                
                // Filtro por plan
                const matchesPlan = !planFilter || web.plan === planFilter;
                
                return matchesSearch && matchesStatus && matchesPlan;
            });
            
            renderWebsGrid(filtered);
        }

        function resetWebsFilters() {
            document.getElementById('searchWebsInput').value = '';
            document.getElementById('filterStatusWebs').value = '';
            document.getElementById('filterPlanWebs').value = '';
            renderWebsGrid(allWebsData);
        }

        function viewWebDetails(clientId) {
            // Reutilizamos la funci√≥n viewClient para mostrar todos los detalles
            viewClient(clientId);
        }
        
        // üÜï Funci√≥n para editar gesti√≥n de web (WordPress URL y Screenshot)
        async function editWebManagement(clientId) {
            try {
                console.log('‚öôÔ∏è [ADMIN] Editando gesti√≥n de web para cliente #', clientId);
                
                // Obtener datos del cliente
                const response = await fetch(`${API_URL}/api/clients/${clientId}`);
                const client = await response.json();
                
                console.log('üìã [ADMIN] Cliente:', client);
                
                // Rellenar el formulario
                document.getElementById('webManagementClientId').value = client.id;
                document.getElementById('webManagementInfo').textContent = `${client.full_name} - ${client.business_name || 'N/A'}`;
                
                document.getElementById('websiteUrlInput').value = client.website_url || '';
                document.getElementById('wordpressUrlInput').value = client.wordpress_url || '';
                document.getElementById('screenshotUrlInput').value = client.website_screenshot_url || '';
                document.getElementById('gaPropertyIdInput').value = client.ga_property_id || '';
                document.getElementById('wpUsernameInput').value = client.wordpress_username || '';
                document.getElementById('wpPasswordInput').value = client.wordpress_password || '';
                
                // Mostrar modal
                document.getElementById('webManagementModal').classList.add('active');
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando gesti√≥n de web:', error);
                showNotification('Error al cargar la informaci√≥n', 'error');
            }
        }
        
        function closeWebManagementModal() {
            document.getElementById('webManagementModal').classList.remove('active');
            document.getElementById('webManagementForm').reset();
        }
        
        async function saveWebManagement(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('webManagementClientId').value;
            const website_url = document.getElementById('websiteUrlInput').value.trim();
            const wordpress_url = document.getElementById('wordpressUrlInput').value.trim();
            const website_screenshot_url = document.getElementById('screenshotUrlInput').value.trim();
            const ga_property_id = document.getElementById('gaPropertyIdInput').value.trim();
            const wordpress_username = document.getElementById('wpUsernameInput').value.trim();
            const wordpress_password = document.getElementById('wpPasswordInput').value.trim();
            
            console.log('üíæ [ADMIN] Guardando gesti√≥n de web:', { 
                clientId, 
                website_url, 
                wordpress_url, 
                website_screenshot_url, 
                ga_property_id,
                wordpress_username: wordpress_username ? '***' : '',
                wordpress_password: wordpress_password ? '***' : ''
            });
            
            try {
                const response = await fetch(`${API_URL}/api/admin/website-management/${clientId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        website_url: website_url || null,
                        wordpress_url: wordpress_url || null,
                        website_screenshot_url: website_screenshot_url || null,
                        ga_property_id: ga_property_id || null,
                        wordpress_username: wordpress_username || null,
                        wordpress_password: wordpress_password || null
                    })
                });
                
                if (!response.ok) throw new Error('Error al guardar');
                
                const result = await response.json();
                console.log('‚úÖ [ADMIN] Gesti√≥n guardada:', result);
                
                showNotification('Cambios guardados correctamente', 'success');
                closeWebManagementModal();
                
                // Recargar las webs para mostrar los cambios
                loadWebsDesplegadas();
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error guardando gesti√≥n:', error);
                showNotification('Error al guardar los cambios', 'error');
            }
        }
        
        // Funci√≥n para activar una web y notificar al cliente
        async function activateWebsite(clientId, clientName, businessName) {
            const displayName = businessName || clientName || 'el cliente';
            
            const confirmed = await showConfirmation(
                `üöÄ ¬øActivar la web de "${displayName}"?\n\n` +
                `Al confirmar:\n` +
                `‚Ä¢ El proyecto se marcar√° como entregado\n` +
                `‚Ä¢ Se notificar√° al cliente por email\n` +
                `‚Ä¢ La web aparecer√° como "Activa" en su dashboard`
            );
            
            if (!confirmed) {
                console.log('‚ö†Ô∏è [ADMIN] Activaci√≥n cancelada por el usuario');
                return;
            }
            
            try {
                console.log(`üöÄ [ADMIN] Activando web para cliente #${clientId}`);
                
                // 1. Actualizar estado del cliente a "activo"
                console.log('üì§ [ADMIN] Paso 1: Actualizando estado del cliente...');
                const clientResponse = await fetch(`${API_URL}/api/client/website-status/${clientId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        status: 'activo',
                        website_url: null  // Mantener la URL actual
                    })
                });
                
                if (!clientResponse.ok) {
                    throw new Error(`Error actualizando cliente: ${clientResponse.status}`);
                }
                
                console.log('‚úÖ [ADMIN] Cliente actualizado a estado "activo"');
                
                // 2. Buscar y actualizar el proyecto asociado a "entregada"
                console.log('üì§ [ADMIN] Paso 2: Buscando proyecto del cliente...');
                const projectsResponse = await fetch(`${API_URL}/api/admin/projects`);
                const allProjects = await projectsResponse.json();
                const clientProject = allProjects.find(p => p.client_id === clientId);
                
                if (clientProject) {
                    console.log(`üì§ [ADMIN] Paso 3: Actualizando proyecto #${clientProject.id} a "entregada"...`);
                    const projectResponse = await fetch(`${API_URL}/api/admin/projects/${clientProject.id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'entregada' })
                    });
                    
                    if (!projectResponse.ok) {
                        throw new Error(`Error actualizando proyecto: ${projectResponse.status}`);
                    }
                    
                    console.log('‚úÖ [ADMIN] Proyecto marcado como "entregada"');
                } else {
                    console.warn('‚ö†Ô∏è [ADMIN] No se encontr√≥ proyecto asociado al cliente');
                }
                
                // 3. Mostrar notificaci√≥n de √©xito
                showNotification(
                    `üéâ ¬°Web activada exitosamente!\n\n` +
                    `‚úÖ Estado cambiado a "Activo"\n` +
                    `‚úÖ Proyecto marcado como "Entregado"\n` +
                    `‚úÖ El cliente ha sido notificado`,
                    'success'
                );
                
                // 4. Recargar las webs desplegadas para mostrar el cambio
                console.log('üîÑ [ADMIN] Recargando webs desplegadas...');
                await loadWebsDesplegadas();
                
                console.log('‚úÖ [ADMIN] Activaci√≥n completada exitosamente');
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error activando web:', error);
                showNotification(
                    'Error al activar la web: ' + error.message,
                    'error'
                );
            }
        }

        async function deployWebFromProject() {
            const form = document.getElementById('projectForm');
            const clientId = form.dataset.clientId;
            const projectName = document.getElementById('projectName').value;
            
            if (!clientId) {
                showNotification('No se pudo identificar el cliente', 'error');
                return;
            }
            
            const confirmed = await showConfirmation(
                `üöÄ ¬øCrear "${projectName}" en Webs Desplegadas?\n\n` +
                `Esta acci√≥n:\n` +
                `‚Ä¢ Crear√° una entrada en la secci√≥n "Webs Desplegadas"\n` +
                `‚Ä¢ Permitir√° configurar el enlace de WordPress\n` +
                `‚Ä¢ Solo se puede hacer una vez por proyecto\n\n` +
                `¬øContinuar?`
            );
            
            if (!confirmed) {
                console.log('‚ö†Ô∏è [ADMIN] Despliegue cancelado');
                return;
            }
            
            try {
                console.log(`üöÄ [ADMIN] Desplegando web para cliente #${clientId}`);
                
                // Crear entrada en "Webs Desplegadas" agregando un placeholder en wordpress_url
                const response = await fetch(`${API_URL}/api/admin/website-management/${clientId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wordpress_url: 'PENDIENTE', // Marcador para indicar que est√° en proceso
                        website_screenshot_url: null
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error al crear entrada en Webs Desplegadas');
                }
                
                console.log('‚úÖ [ADMIN] Entrada creada en Webs Desplegadas');
                
                showNotification(
                    `üéâ ¬°Web desplegada!\n\n` +
                    `‚úÖ "${projectName}" ahora aparece en Webs Desplegadas\n` +
                    `üìù Ve a "Webs Desplegadas" para configurar WordPress`,
                    'success'
                );
                
                // Actualizar el clientId en el dataset para reflejar el cambio
                form.dataset.wordpressConfigured = 'true';
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error desplegando web:', error);
                showNotification(
                    'Error al desplegar la web: ' + error.message,
                    'error'
                );
            }
        }

        // ===== FACTURAS =====
        let allInvoicesData = [];
        let filteredInvoicesData = [];
        let currentPeriod = 'week';

        async function loadAllInvoices() {
            try {
                console.log('üßæ [ADMIN] Cargando todas las facturas...');
                
                const tbody = document.getElementById('invoicesTable');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loader"><div class="spinner"></div><p>Cargando facturas...</p></div></td></tr>';
                
                const response = await fetch(`${API_URL}/api/admin/invoices`);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Debug info
                if (data.debug) {
                    console.log('üìä [ADMIN] Debug info:', data.debug);
                    console.log(`   - Total clientes: ${data.debug.totalClients}`);
                    console.log(`   - Clientes con Stripe: ${data.debug.clientsWithStripe}`);
                    console.log(`   - Total facturas: ${data.debug.totalInvoices}`);
                    
                    if (data.debug.clientsWithStripe === 0) {
                        console.warn('‚ö†Ô∏è [ADMIN] No hay clientes con stripe_customer_id');
                        console.warn('üí° [ADMIN] Esto significa que no ha habido pagos reales todav√≠a');
                        console.warn('üí° [ADMIN] Los clientes creados con la herramienta de test NO tienen pagos en Stripe');
                    }
                }
                
                allInvoicesData = data.invoices || [];
                console.log(`‚úÖ [ADMIN] ${allInvoicesData.length} facturas cargadas desde Stripe`);
                
                // Aplicar filtro inicial (√∫ltima semana)
                filterInvoicesByPeriod(currentPeriod);
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando facturas:', error);
                const tbody = document.getElementById('invoicesTable');
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: #EF4444;">Error al cargar las facturas: ${error.message}</td></tr>`;
            }
        }

        // ===== CANCELACIONES =====
        async function loadCancellations() {
            try {
                console.log('üö´ [ADMIN] Cargando cancelaciones...');
                
                const tbody = document.getElementById('cancellationsTable');
                console.log('üîç [DEBUG] tbody element:', tbody);
                
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;"><div class="loader"><div class="spinner"></div><p>Cargando cancelaciones...</p></div></td></tr>';
                
                const response = await fetch(`${API_URL}/api/admin/cancelaciones`);
                console.log('üîç [DEBUG] Response status:', response.status);
                
                const cancelaciones = await response.json();
                
                console.log(`‚úÖ [ADMIN] Datos de cancelaciones:`, cancelaciones);
                console.log('üîç [DEBUG] Es array?', Array.isArray(cancelaciones));
                console.log('üîç [DEBUG] Longitud:', cancelaciones?.length);
                console.log('üîç [DEBUG] Primer elemento:', cancelaciones?.[0]);
                
                // Actualizar estad√≠sticas
                // Canceladas: subscription_status puede ser 'canceled', 'cancelled', o tener cancelled_at
                const totalCancelled = cancelaciones.filter(c => 
                    c.subscription_status === 'canceled' || 
                    c.subscription_status === 'cancelled' || 
                    (c.cancelled_at && c.subscription_end_date && new Date(c.subscription_end_date) < new Date())
                ).length;
                
                // Pendientes: tienen cancelled_at pero a√∫n est√°n activas (no han expirado)
                const pendingCancellation = cancelaciones.filter(c => 
                    c.cancelled_at && 
                    (!c.subscription_end_date || new Date(c.subscription_end_date) >= new Date())
                ).length;
                
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const cancelledThisMonth = cancelaciones.filter(c => {
                    const cancelDate = new Date(c.cancelled_at);
                    return cancelDate >= startOfMonth;
                }).length;
                
                // Calcular ingresos perdidos (todas las cancelaciones, no solo expiradas)
                const planPrices = { basico: 35, avanzado: 49, premium: 65 };
                const lostRevenue = cancelaciones
                    .filter(c => c.cancelled_at) // Todas las que tienen cancelaci√≥n
                    .reduce((sum, c) => sum + (planPrices[c.plan] || 0), 0);
                
                document.getElementById('totalCancelledCount').textContent = totalCancelled;
                document.getElementById('pendingCancellationCount').textContent = pendingCancellation;
                document.getElementById('cancelledThisMonthCount').textContent = cancelledThisMonth;
                document.getElementById('lostRevenueAmount').textContent = `${lostRevenue}‚Ç¨`;
                
                // Renderizar tabla
                console.log('üîç [DEBUG] Verificando longitud:', cancelaciones.length);
                
                if (cancelaciones.length === 0) {
                    console.log('‚ö†Ô∏è [ADMIN] Array vac√≠o, mostrando mensaje');
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No hay cancelaciones registradas</td></tr>';
                    return;
                }
                
                console.log('üîç [DEBUG] Iniciando renderizado de tabla...');
                
                try {
                    tbody.innerHTML = cancelaciones.map(c => {
                    const cancelDate = new Date(c.cancelled_at);
                    const endDate = c.subscription_end_date ? new Date(c.subscription_end_date) : null;
                    
                    // Verificar si es una cancelaci√≥n NUEVA (nunca vista por el admin)
                    const isNewCancellation = !c.admin_viewed_cancellation_at;
                    
                    // Determinar si est√° cancelada o pendiente de expirar
                    const isCancelled = c.subscription_status === 'canceled' || 
                                      c.subscription_status === 'cancelled' ||
                                      (c.subscription_end_date && new Date(c.subscription_end_date) < new Date());
                    
                    const status = isCancelled ? 'Cancelada' : 'Pendiente de expirar';
                    const statusColor = isCancelled ? '#EF4444' : '#F59E0B';
                    
                    return `
                        <tr style="${isNewCancellation ? 'background: #e3f2fd;' : ''}">
                            <td>${c.id}</td>
                            <td>
                                <div style="font-weight: 600;">${c.full_name || c.business_name}</div>
                                <div style="font-size: 0.85rem; color: #666;">${c.email}</div>
                            </td>
                            <td>
                                <span style="padding: 4px 12px; background: #e8f4ff; color: #0046FE; border-radius: 12px; font-size: 0.85rem; font-weight: 600; text-transform: capitalize;">
                                    ${c.plan}
                                </span>
                            </td>
                            <td>
                                <span style="padding: 4px 12px; background: ${statusColor}20; color: ${statusColor}; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                    ${status}
                                </span>
                            </td>
                            <td>${cancelDate.toLocaleDateString('es-ES')}</td>
                            <td>${endDate ? endDate.toLocaleDateString('es-ES') : '-'}</td>
                            <td>
                                <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${c.cancellation_reason || 'No especificada'}">
                                    ${c.cancellation_reason || 'No especificada'}
                                </div>
                            </td>
                            <td>
                                <button onclick="viewClient(${c.id})" style="padding: 6px 12px; background: #0046FE; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                    Ver Cliente
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log(`‚úÖ [ADMIN] ${cancelaciones.length} cancelaciones renderizadas`);
                console.log('üîç [DEBUG] HTML generado, longitud:', tbody.innerHTML.length);
                
                } catch (renderError) {
                    console.error('‚ùå [ADMIN] Error renderizando tabla:', renderError);
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px; color: #EF4444;">Error renderizando: ${renderError.message}</td></tr>`;
                }
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando cancelaciones:', error);
                const tbody = document.getElementById('cancellationsTable');
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px; color: #EF4444;">Error al cargar cancelaciones: ${error.message}</td></tr>`;
            }
        }

        function filterInvoicesByPeriod(period) {
            currentPeriod = period;
            console.log(`üìÖ [ADMIN] Filtrando facturas por: ${period}`);
            
            // Actualizar botones activos
            document.querySelectorAll('.btn-filter').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.style.background = 'linear-gradient(135deg, #0046FE 0%, #0056FF 100%)';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#0046FE';
                    btn.style.boxShadow = '0 4px 12px rgba(0, 70, 254, 0.3)';
                    btn.style.transform = 'translateY(-2px)';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#4b5563';
                    btn.style.borderColor = '#e5e7eb';
                    btn.style.boxShadow = 'none';
                    btn.style.transform = 'translateY(0)';
                }
            });
            
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'quarter':
                    startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                    startDate = new Date(0); // Desde el inicio de los tiempos
                    break;
                default:
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            }
            
            // Filtrar facturas por fecha
            filteredInvoicesData = allInvoicesData.filter(invoice => {
                const invoiceDate = new Date(invoice.created);
                return invoiceDate >= startDate;
            });
            
            console.log(`‚úÖ [ADMIN] ${filteredInvoicesData.length} facturas en el per√≠odo seleccionado`);
            
            // Renderizar
            renderInvoicesTable();
            updateInvoicesStats();
        }

        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTable');
            
            if (filteredInvoicesData.length === 0) {
                // Verificar si hay facturas en total
                if (allInvoicesData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 60px;">
                                <div style="color: #666;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">üì≠</div>
                                    <h3 style="color: #333; margin-bottom: 10px;">No hay facturas registradas</h3>
                                    <p style="color: #999; margin-bottom: 15px;">Las facturas aparecer√°n aqu√≠ una vez que los clientes realicen pagos a trav√©s de Stripe</p>
                                    <p style="font-size: 0.85rem; color: #999; background: #f8f9fa; padding: 12px; border-radius: 8px; display: inline-block;">
                                        üí° <strong>Nota:</strong> Los clientes de prueba NO generan facturas reales en Stripe
                                    </p>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No hay facturas en este per√≠odo</td></tr>';
                }
                return;
            }
            
            tbody.innerHTML = filteredInvoicesData.map(invoice => {
                const date = new Date(invoice.created).toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                const statusColors = {
                    'paid': { badge: 'success', text: 'Pagada' },
                    'open': { badge: 'warning', text: 'Pendiente' },
                    'void': { badge: 'secondary', text: 'Anulada' },
                    'uncollectible': { badge: 'danger', text: 'Impagada' }
                };
                
                const status = statusColors[invoice.status] || { badge: 'secondary', text: invoice.status };
                
                return `
                    <tr>
                        <td><strong>${invoice.number}</strong></td>
                        <td>${invoice.client_name || 'N/A'}</td>
                        <td>${invoice.client_business || invoice.client_email || 'N/A'}</td>
                        <td>
                            <strong style="color: #0046FE; font-size: 1.05rem;">${invoice.amount}‚Ç¨</strong>
                            ${invoice.amount_without_vat ? `
                                <br><span style="font-size: 0.75rem; color: #999;">
                                    Base: ${invoice.amount_without_vat}‚Ç¨ + IVA: ${invoice.vat_amount}‚Ç¨
                                </span>
                            ` : ''}
                        </td>
                        <td><span class="badge badge-${status.badge}">${status.text}</span></td>
                        <td>${date}</td>
                        <td>
                            ${invoice.pdf_url ? `
                                <a href="${invoice.pdf_url}" target="_blank" class="btn-secondary" style="padding: 6px 12px; font-size: 0.85rem; text-decoration: none; display: inline-block;">
                                    üì• PDF
                                </a>
                            ` : '<span style="color: #999;">N/A</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateInvoicesStats() {
            const totalInvoices = filteredInvoicesData.length;
            const paidInvoices = filteredInvoicesData.filter(inv => inv.status === 'paid').length;
            const pendingInvoices = filteredInvoicesData.filter(inv => inv.status === 'open').length;
            const totalRevenue = filteredInvoicesData
                .filter(inv => inv.status === 'paid')
                .reduce((sum, inv) => sum + parseFloat(inv.amount), 0);
            
            document.getElementById('totalInvoices').textContent = totalInvoices;
            document.getElementById('paidInvoices').textContent = paidInvoices;
            document.getElementById('pendingInvoices').textContent = pendingInvoices;
            document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)}‚Ç¨`;
        }

        function exportInvoices() {
            if (filteredInvoicesData.length === 0) {
                showNotification('No hay facturas para exportar en este per√≠odo', 'error');
                return;
            }
            
            console.log('üì• [ADMIN] Exportando facturas a CSV...');
            
            // Crear CSV con facturas filtradas
            const headers = ['N¬∫ Factura', 'Cliente', 'Empresa', 'Email', 'Monto', 'Moneda', 'Estado', 'Fecha', 'PDF URL'];
            const rows = filteredInvoicesData.map(inv => [
                inv.number,
                inv.client_name || '',
                inv.client_business || '',
                inv.client_email || '',
                inv.amount,
                inv.currency,
                inv.status,
                new Date(inv.created).toLocaleDateString('es-ES'),
                inv.pdf_url || ''
            ]);
            
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(',') + '\n';
            });
            
            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `facturas_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            console.log('‚úÖ [ADMIN] CSV descargado');
            showNotification('Facturas exportadas correctamente', 'success');
        }

        // Event listeners para filtros
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchWebsInput');
            const statusFilter = document.getElementById('filterStatusWebs');
            const planFilter = document.getElementById('filterPlanWebs');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterWebs);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', filterWebs);
            }
            if (planFilter) {
                planFilter.addEventListener('change', filterWebs);
            }
        });

        // ===== PROYECTOS (KANBAN) =====
        async function loadProjects() {
            try {
                console.log('üìã [ADMIN] Cargando proyectos para Kanban...');
                const response = await fetch(`${API_URL}/api/admin/projects`);
                const projects = await response.json();
                
                console.log('üìã [ADMIN] Proyectos recibidos:', projects.length, 'proyectos');
                console.log('üìã [ADMIN] Datos completos:', projects);
                
                // Mapeo de estados del backend al frontend
                const statusMapping = {
                    'sin_empezar': 'sin-empezar',
                    'en_desarrollo': 'desarrollo',
                    'revision': 'revision',
                    'entregada': 'entregada'
                };
                
                // Limpiar todas las columnas
                Object.values(statusMapping).forEach(columnId => {
                    const column = document.getElementById(`kanban-${columnId}`);
                    if (column) column.innerHTML = '';
                });
                
                // Agrupar proyectos por estado (usando estados del backend)
                const projectsByStatus = {
                    'sin_empezar': [],
                    'en_desarrollo': [],
                    'revision': [],
                    'entregada': []
                };
                
                console.log('üîç [DEBUG] Iniciando iteraci√≥n de proyectos...');
                console.log('üîç [DEBUG] Array projects:', Array.isArray(projects), 'Length:', projects.length);
                
                projects.forEach((project, index) => {
                    console.log(`\nüìã [ADMIN] === Proyecto ${index + 1}/${projects.length} ===`);
                    console.log(`üìã [ADMIN] ID: ${project.id}`);
                    console.log(`üìã [ADMIN] Nombre: "${project.project_name || project.business_name}"`);
                    console.log(`üìã [ADMIN] Estado: "${project.status}"`);
                    console.log(`üìã [ADMIN] Cliente: ${project.client_email}`);
                    
                    if (projectsByStatus[project.status] !== undefined) {
                        projectsByStatus[project.status].push(project);
                        console.log(`‚úÖ [ADMIN] Proyecto agregado a: ${project.status}`);
                    } else {
                        console.error(`‚ùå [ADMIN] Estado desconocido: "${project.status}"`);
                        console.error(`‚ùå [ADMIN] Estados v√°lidos:`, Object.keys(projectsByStatus));
                    }
                });
                
                console.log('\nüîç [DEBUG] Iteraci√≥n completada');
                
                console.log('üìã [ADMIN] Proyectos agrupados:', {
                    sin_empezar: projectsByStatus.sin_empezar.length,
                    en_desarrollo: projectsByStatus.en_desarrollo.length,
                    revision: projectsByStatus.revision.length,
                    entregada: projectsByStatus.entregada.length
                });
                
                // Renderizar proyectos en cada columna
                Object.keys(projectsByStatus).forEach(backendStatus => {
                    const columnId = statusMapping[backendStatus];
                    const column = document.getElementById(`kanban-${columnId}`);
                    const count = document.getElementById(`count-${columnId}`);
                    
                    if (!column || !count) {
                        console.error(`‚ùå [ADMIN] Columna no encontrada: kanban-${columnId}`);
                        return;
                    }
                    
                    const projectList = projectsByStatus[backendStatus] || [];
                    count.textContent = projectList.length;
                    
                    console.log(`üé® [RENDER] Columna: ${columnId}, Proyectos: ${projectList.length}`);
                    
                    if (projectList.length === 0) {
                        console.log(`üì≠ [RENDER] Columna ${columnId} vac√≠a, mostrando mensaje`);
                        column.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #999; font-size: 0.9rem;">
                                Sin proyectos
                            </div>
                        `;
                    } else {
                        console.log(`üé® [RENDER] Renderizando ${projectList.length} proyecto(s) en ${columnId}`);
                        const html = projectList.map((project, idx) => {
                            console.log(`  üé® [RENDER] Proyecto ${idx + 1}: ${project.project_name || project.business_name}`);
                            return `
                                <div class="kanban-card" draggable="true" data-project-id="${project.id}" ${project.is_upgrade ? 'style="border-left: 4px solid #ff6b35;"' : project.is_downgrade ? 'style="border-left: 4px solid #9333ea;"' : ''}>
                                    <div class="kanban-card-title">
                                        ${project.project_name || project.business_name || 'Proyecto sin nombre'}
                                        ${project.is_upgrade ? '<span class="badge" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; margin-left: 8px; font-size: 0.7rem; padding: 3px 8px;">üîº UPGRADE</span>' : ''}
                                        ${project.is_downgrade ? '<span class="badge" style="background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%); color: white; margin-left: 8px; font-size: 0.7rem; padding: 3px 8px;">üîΩ DOWNGRADE</span>' : ''}
                                    </div>
                                    <div class="kanban-card-info">üë§ ${project.business_name || 'Sin cliente'}</div>
                                    <div class="kanban-card-info">üìß ${project.client_email || 'N/A'}</div>
                                    <div class="kanban-card-info">üì¶ ${project.plan === 'basico' ? 'B√°sico' : project.plan === 'avanzado' ? 'Avanzado' : project.plan === 'premium' ? 'Premium' : project.plan}</div>
                                    ${project.deadline ? `<div class="kanban-card-info">üìÖ ${formatDate(project.deadline)}</div>` : ''}
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                    </div>
                                    <div class="kanban-card-footer">
                                        <span>${project.priority === 'low' ? 'üü¢' : project.priority === 'high' ? 'üü†' : project.priority === 'urgent' ? 'üî¥' : 'üîµ'} ${project.priority || 'normal'}</span>
                                        <span>${project.progress || 0}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        console.log(`üìù [RENDER] HTML generado (${html.length} caracteres)`);
                        column.innerHTML = html;
                        console.log(`‚úÖ [RENDER] innerHTML asignado a columna ${columnId}`);
                        
                        // Verificar que realmente se renderiz√≥
                        const cardsInColumn = column.querySelectorAll('.kanban-card').length;
                        console.log(`‚úÖ [RENDER] Tarjetas encontradas en ${columnId}: ${cardsInColumn}`);
                        
                        // A√±adir event listeners para drag & drop
                        column.querySelectorAll('.kanban-card').forEach(card => {
                            card.addEventListener('dragstart', handleDragStart);
                            card.addEventListener('click', () => editProject(card.dataset.projectId));
                        });
                    }
                });
                
                // A√±adir event listeners para drop zones
                Object.keys(projectsByStatus).forEach(backendStatus => {
                    const columnId = statusMapping[backendStatus];
                    const column = document.getElementById(`kanban-${columnId}`)?.parentElement;
                    if (column) {
                        column.addEventListener('dragover', handleDragOver);
                        column.addEventListener('drop', (e) => handleDrop(e, backendStatus));
                    }
                });
                
                // Actualizar estad√≠sticas (opcional, no bloquea si falla)
                try {
                    const statsResponse = await fetch(`${API_URL}/api/admin/projects/stats`);
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        if (document.getElementById('websInProgress')) {
                            document.getElementById('websInProgress').textContent = stats.en_desarrollo || 0;
                        }
                    }
                } catch (statsError) {
                    console.warn('‚ö†Ô∏è [ADMIN] No se pudieron cargar estad√≠sticas de proyectos:', statsError);
                }
                
                console.log('‚úÖ [ADMIN] Proyectos cargados correctamente en Kanban');
                
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando proyectos:', error);
            }
        }
        
        // Drag & Drop handlers
        let draggedProject = null;
        
        function handleDragStart(e) {
            draggedProject = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.target.style.opacity = '0.5';
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        async function handleDrop(e, newStatus) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedProject) {
                const projectId = draggedProject.dataset.projectId;
                draggedProject.style.opacity = '';
                
                console.log(`üéØ [ADMIN] Moviendo proyecto #${projectId} a estado: ${newStatus}`);
                
                // Si se mueve a "Entregada", pedir confirmaci√≥n
                if (newStatus === 'entregada') {
                    const confirmed = await showConfirmation(
                        'üöÄ ¬øMarcar como ENTREGADO?\n\n' +
                        'Al confirmar:\n' +
                        '‚Ä¢ El cliente ser√° notificado\n' +
                        '‚Ä¢ La web aparecer√° como "Activa"\n' +
                        '‚Ä¢ El progreso se completar√° al 100%'
                    );
                    
                    if (!confirmed) {
                        console.log('‚ö†Ô∏è [ADMIN] Movimiento cancelado por el usuario');
                        return false;
                    }
                }
                
                try {
                    // Calcular progreso autom√°tico seg√∫n la columna
                    const progressByStatus = {
                        'sin_empezar': 0,
                        'en_desarrollo': 50,
                        'revision': 75,
                        'entregada': 100
                    };
                    
                    const autoProgress = progressByStatus[newStatus] !== undefined ? progressByStatus[newStatus] : 0;
                    console.log(`üìä [ADMIN] Progreso autom√°tico para '${newStatus}': ${autoProgress}%`);
                    
                    // Actualizar estado Y progreso en el backend
                    console.log(`üì§ [ADMIN] Enviando PATCH a /api/admin/projects/${projectId} con status: ${newStatus} y progress: ${autoProgress}`);
                    const updateResponse = await fetch(`${API_URL}/api/admin/projects/${projectId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            status: newStatus,
                            progress: autoProgress
                        })
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error(`Error ${updateResponse.status}: ${await updateResponse.text()}`);
                    }
                    
                    const result = await updateResponse.json();
                    console.log(`‚úÖ [ADMIN] Proyecto actualizado:`, result);
                    
                    // Si se marc√≥ como entregada, actualizar el cliente
                    if (newStatus === 'entregada') {
                        const projectResponse = await fetch(`${API_URL}/api/admin/projects/${projectId}`);
                        const project = await projectResponse.json();
                        
                        if (project.client_id) {
                            // Actualizar estado del sitio web del cliente a "activo"
                            await fetch(`${API_URL}/api/client/website-status/${project.client_id}`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    status: 'activo',
                                    website_url: project.website_url || null
                                })
                            });
                            
                            showNotification('Proyecto marcado como entregado. El cliente ha sido notificado y su sitio est√° ahora ACTIVO.', 'success');
                        }
                    } else {
                        showNotification('Proyecto movido exitosamente', 'success');
                    }
                    
                    // Recargar proyectos
                    console.log('üîÑ [ADMIN] Recargando proyectos despu√©s de mover...');
                    await loadProjects();
                    console.log('‚úÖ [ADMIN] Proyectos recargados');
                } catch (error) {
                    console.error('‚ùå [ADMIN] Error moviendo proyecto:', error);
                    showNotification('Error moviendo el proyecto: ' + error.message, 'error');
                    // Recargar de todos modos para restaurar el estado visual
                    await loadProjects();
                }
            }
            
            return false;
        }
        
        // Editar proyecto
        async function editProject(projectId) {
            try {
                console.log(`üìù [ADMIN] Editando proyecto #${projectId}`);
                
                // 1Ô∏è‚É£ Obtener datos del proyecto
                const response = await fetch(`${API_URL}/api/admin/projects/${projectId}`);
                const project = await response.json();
                console.log('üìù [ADMIN] Datos del proyecto:', project);
                
                // 2Ô∏è‚É£ Cargar clientes PRIMERO
                console.log('üìù [ADMIN] Cargando clientes para dropdown...');
                await loadClientsForSelect();
                
                // 3Ô∏è‚É£ AHORA s√≠, pre-llenar modal con datos del proyecto
                console.log(`üìù [ADMIN] Asignando cliente #${project.client_id} al dropdown`);
                document.getElementById('projectClient').value = project.client_id;
                document.getElementById('projectName').value = project.project_name;
                document.getElementById('projectStatus').value = project.status;
                document.getElementById('projectPriority').value = project.priority;
                
                // Formatear deadline para input type="date" (YYYY-MM-DD)
                console.log(`üìÖ [ADMIN] Deadline original:`, project.deadline);
                let formattedDeadline = '';
                if (project.deadline) {
                    // Si viene como Date object o string, convertir a YYYY-MM-DD
                    const deadlineDate = new Date(project.deadline);
                    if (!isNaN(deadlineDate.getTime())) {
                        formattedDeadline = deadlineDate.toISOString().split('T')[0];
                        console.log(`üìÖ [ADMIN] Deadline formateado: ${formattedDeadline}`);
                    } else {
                        console.warn(`‚ö†Ô∏è [ADMIN] Deadline inv√°lido: ${project.deadline}`);
                    }
                }
                document.getElementById('projectDeadline').value = formattedDeadline;
                console.log(`üìÖ [ADMIN] Deadline asignado al input:`, document.getElementById('projectDeadline').value);
                
                document.getElementById('projectProgress').value = project.progress;
                document.getElementById('projectNotes').value = project.notes || '';
                
                // Verificar si el cliente se asign√≥ correctamente
                const selectedClientId = document.getElementById('projectClient').value;
                console.log(`üìù [ADMIN] Cliente seleccionado en dropdown: ${selectedClientId}`);
                
                if (selectedClientId != project.client_id) {
                    console.warn(`‚ö†Ô∏è [ADMIN] El cliente no se asign√≥ correctamente. Esperado: ${project.client_id}, Actual: ${selectedClientId}`);
                }
                
                // Ya no hay bot√≥n "Desplegar Proyecto" en el modal - fue eliminado
                console.log('‚úÖ [ADMIN] Proyecto cargado para edici√≥n (sin bot√≥n deploy)')
                
                // Cambiar el formulario a modo edici√≥n
                const form = document.getElementById('projectForm');
                form.dataset.projectId = projectId;
                form.dataset.clientId = project.client_id; // Guardar client_id para el bot√≥n
                form.dataset.mode = 'edit';
                
                // Cambiar t√≠tulo del modal
                document.querySelector('#projectModal .modal-header h3').textContent = '‚úèÔ∏è Editar Proyecto';
                
                document.getElementById('projectModal').classList.add('active');
                console.log('‚úÖ [ADMIN] Modal de edici√≥n abierto correctamente');
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando datos del proyecto:', error);
                showNotification('Error cargando datos del proyecto', 'error');
            }
        }

        function openNewProjectModal() {
            const form = document.getElementById('projectForm');
            delete form.dataset.projectId;
            delete form.dataset.clientId;
            delete form.dataset.mode;
            form.reset();
            document.querySelector('#projectModal .modal-header h3').textContent = 'üåê Nuevo Proyecto';
            
            document.getElementById('projectModal').classList.add('active');
            loadClientsForSelect();
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('active');
            const form = document.getElementById('projectForm');
            form.reset();
            delete form.dataset.projectId;
            delete form.dataset.mode;
        }

        async function loadClientsForSelect() {
            try {
                console.log('üîç [ADMIN] Cargando clientes para dropdown...');
                const response = await fetch(`${API_URL}/api/clients`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const clients = await response.json();
                console.log(`üìã [ADMIN] Clientes recibidos:`, clients);
                console.log(`üìä [ADMIN] Total de clientes: ${clients.length}`);
                
                const select = document.getElementById('projectClient');
                
                if (clients.length === 0) {
                    console.warn('‚ö†Ô∏è [ADMIN] No hay clientes disponibles');
                    select.innerHTML = '<option value="">No hay clientes disponibles</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">Selecciona un cliente...</option>' +
                    clients.map(c => {
                        const clientName = c.full_name || c.email || 'Sin nombre';
                        console.log(`‚ûï [ADMIN] Agregando cliente: ${clientName} (ID: ${c.id}, Email: ${c.email})`);
                        return `<option value="${c.id}">${clientName} (${c.email})</option>`;
                    }).join('');
                    
                console.log('‚úÖ [ADMIN] Dropdown de clientes cargado correctamente');
            } catch (error) {
                console.error('‚ùå [ADMIN] Error cargando clientes:', error);
                showNotification('Error al cargar clientes: ' + error.message, 'error');
            }
        }

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const projectData = {
                client_id: parseInt(document.getElementById('projectClient').value),
                project_name: document.getElementById('projectName').value,
                // status: No se env√≠a, se cambia solo arrastrando en el Kanban
                priority: document.getElementById('projectPriority').value,
                deadline: document.getElementById('projectDeadline').value || null,
                progress: parseInt(document.getElementById('projectProgress').value),
                notes: document.getElementById('projectNotes').value || null
            };
            
            try {
                if (form.dataset.mode === 'edit' && form.dataset.projectId) {
                    // Modo edici√≥n
                    await fetch(`${API_URL}/api/admin/projects/${form.dataset.projectId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(projectData)
                    });
                    showNotification('Proyecto actualizado exitosamente', 'success');
                } else {
                    // Modo creaci√≥n
                    await fetch(`${API_URL}/api/admin/projects`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(projectData)
                    });
                    showNotification('Proyecto creado exitosamente', 'success');
                }
                
                closeProjectModal();
                await loadProjects();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error guardando el proyecto', 'error');
            }
        });

        // ===== ACTUALIZACI√ìN AUTOM√ÅTICA DE TICKETS =====
        let autoUpdateIntervalAdmin = null;

        // Variable para rastrear el ticket actualmente abierto en admin
        let currentOpenAdminTicketId = null;

        async function updateAdminUnreadBadge() {
            try {
                console.log('üîÑ [AUTO-UPDATE ADMIN] Actualizando contador de mensajes...');
                const response = await fetch(`${API_URL}/api/tickets`);
                
                if (!response.ok) return;
                
                const allTickets = await response.json();
                
                // FILTRAR: Excluir tickets de facturaci√≥n (upgrades/downgrades autom√°ticos)
                const tickets = allTickets.filter(t => t.category !== 'facturacion');
                
                // Contar mensajes sin leer del admin
                const unreadCount = tickets.filter(t => t.admin_unread === true).length;
                console.log('üîî [AUTO-UPDATE ADMIN] Mensajes sin leer:', unreadCount);
                
                // Actualizar badge en el men√∫
                const badge = document.getElementById('unreadBadgeMenuAdmin');
                if (badge) {
                    const previousCount = parseInt(badge.textContent) || 0;
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline-block';
                        
                        // Si hay mensajes nuevos que antes no hab√≠a, mostrar notificaci√≥n
                        if (unreadCount > previousCount && previousCount >= 0) {
                            const newMessages = unreadCount - previousCount;
                            if (newMessages > 0) {
                                showNotification(`${newMessages} mensaje${newMessages > 1 ? 's' : ''} nuevo${newMessages > 1 ? 's' : ''} del cliente`, 'info');
                            }
                        }
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // Si estamos en la secci√≥n de tickets, recargar la tabla
                const ticketsSection = document.getElementById('tickets');
                if (ticketsSection && ticketsSection.style.display !== 'none') {
                    const tbody = document.getElementById('ticketsTable');
                    if (tbody) {
                        // Recargar tabla completa
                        loadTickets();
                    }
                }
                
                // üÜï Si hay un modal de ticket abierto, actualizarlo autom√°ticamente
                const modal = document.getElementById('ticketModal');
                if (modal && modal.style.display === 'flex' && currentOpenAdminTicketId) {
                    console.log(`üîÑ [AUTO-UPDATE ADMIN] Actualizando ticket abierto #${currentOpenAdminTicketId}`);
                    await refreshAdminOpenTicket(currentOpenAdminTicketId);
                }
                
            } catch (error) {
                console.error('‚ùå [AUTO-UPDATE ADMIN] Error actualizando badge:', error);
            }
        }

        // üÜï Funci√≥n para actualizar el ticket abierto en el modal admin (sin marcarlo como le√≠do)
        async function refreshAdminOpenTicket(ticketId) {
            try {
                // NO marcar como le√≠do, solo obtener los datos
                const response = await fetch(`${API_URL}/api/tickets/${ticketId}`);
                if (!response.ok) throw new Error('Error al obtener ticket');
                
                const ticket = await response.json();
                
                // Recargar completamente el contenido del modal (sin marcar como le√≠do)
                const detailsDiv = document.getElementById('ticketDetails');
                if (!detailsDiv) return;
                
                const priorityColors = {
                    'alta': 'danger',
                    'media': 'warning',
                    'baja': 'info'
                };
                
                const statusColors = {
                    'abierto': 'warning',
                    'en_proceso': 'info',
                    'cerrado': 'success'
                };
                
                const statusText = {
                    'abierto': 'Abierto',
                    'en_proceso': 'En Proceso',
                    'cerrado': 'Cerrado'
                };
                
                // Actualizar solo la parte que puede cambiar (respuestas del cliente)
                // Primero verificar si hay una nueva respuesta del cliente
                const clientResponseDiv = detailsDiv.querySelector('[data-client-response]');
                const hasNewClientResponse = ticket.client_response && (!clientResponseDiv || clientResponseDiv.getAttribute('data-timestamp') !== ticket.client_response_at);
                
                if (hasNewClientResponse || ticket.admin_response) {
                    // Solo actualizar si hay cambios en las respuestas
                    // Buscar y actualizar la secci√≥n de respuesta del cliente
                    if (ticket.client_response) {
                        const clientResponseHTML = `
                            <div style="border: 2px solid #0046FE; background: #e8f4ff; border-radius: 10px; padding: 15px; margin-bottom: 15px;" data-client-response data-timestamp="${ticket.client_response_at || ''}">
                                <h4 style="color: #0046FE; margin: 0 0 10px 0; font-size: 1rem;">üí¨ Respuesta del Cliente</h4>
                                <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap;">${ticket.client_response}</p>
                                ${ticket.client_response_at ? `<p style="margin: 10px 0 0 0; font-size: 0.8rem; color: #666;">üìÖ Enviado: ${formatDate(ticket.client_response_at)}</p>` : ''}
                            </div>
                        `;
                        
                        // Si no existe, agregar despu√©s de la respuesta del admin
                        if (!clientResponseDiv) {
                            const adminResponseDiv = detailsDiv.querySelector('[data-admin-response]');
                            if (adminResponseDiv) {
                                adminResponseDiv.insertAdjacentHTML('afterend', clientResponseHTML);
                                console.log('‚úÖ [AUTO-UPDATE ADMIN] Nueva respuesta del cliente agregada');
                            }
                        }
                    }
                }
                
                console.log('‚úÖ [AUTO-UPDATE ADMIN] Ticket actualizado en modal');
                
            } catch (error) {
                console.error('‚ùå [AUTO-UPDATE ADMIN] Error al actualizar ticket:', error);
            }
        }

        // Iniciar actualizaci√≥n autom√°tica cada 10 segundos
        console.log('‚è∞ [AUTO-UPDATE ADMIN] Iniciando actualizaci√≥n autom√°tica cada 10 segundos');
        
        // Primera actualizaci√≥n inmediata
        updateAdminUnreadBadge();
        
        // Actualizaciones peri√≥dicas cada 10 segundos
        autoUpdateIntervalAdmin = setInterval(updateAdminUnreadBadge, 10000); // 10 segundos

        // üÜï Detectar si volvemos de ver un pedido (desde pedido-detalle.html)
        // üîç Detectar si acabamos de ver un pedido (volviendo de pedido-detalle.html)
        const pedidoViewedOnLoad = localStorage.getItem('pedidoViewed');
        console.log('üîç [ADMIN] Verificando pedidoViewed al cargar p√°gina:', pedidoViewedOnLoad);
        
        if (pedidoViewedOnLoad) {
            const viewedTime = parseInt(pedidoViewedOnLoad);
            const elapsed = Date.now() - viewedTime;
            console.log('üîç [ADMIN] Pedido visto hace:', elapsed + 'ms (' + (elapsed / 1000).toFixed(1) + ' segundos)');
            
            // Si se vio hace menos de 30 segundos, redirigir a pedidos
            if (elapsed < 30000) {
                console.log('üîÑ [ADMIN] ‚úÖ Detectado pedido reci√©n visto al cargar, redirigiendo a secci√≥n Pedidos...');
                console.log('üîÑ [ADMIN] Esperando 300ms para que la p√°gina cargue completamente...');
                // NO eliminar aqu√≠, dejar que showSection lo maneje
                // Peque√±o delay para que la p√°gina cargue completamente
                setTimeout(() => {
                    console.log('üîÑ [ADMIN] ‚è∞ Timeout completado, ejecutando showSection(pedidos)...');
                    showSection('pedidos');
                }, 300); // Aumentado a 300ms para m√°s estabilidad
            } else {
                console.log('‚è∞ [ADMIN] Timestamp muy antiguo (' + (elapsed / 1000).toFixed(1) + 's), limpiando localStorage');
                localStorage.removeItem('pedidoViewed');
            }
        } else {
            console.log('‚úÖ [ADMIN] No hay pedidoViewed en localStorage (primera carga o limpio)');
        }

        // ===== FORMATEADORES =====
        function formatPlan(plan) {
            const names = {
                'basico': 'B√°sico',
                'avanzado': 'Avanzado',
                'premium': 'Premium'
            };
            return names[plan] || plan;
        }

        function formatStatus(status) {
            const names = {
                'paid': 'Pagado',
                'pending': 'Pendiente'
            };
            return names[status] || status;
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // ===== SISTEMA DE NOTIFICACIONES =====
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('customNotification');
            const icon = document.getElementById('notificationIcon');
            const text = document.getElementById('notificationText');
            const progressBar = document.getElementById('notificationProgress');
            
            // Iconos y colores seg√∫n tipo
            const config = {
                success: { icon: '‚úÖ', color: '#009A62', bg: '#f0f9f4', border: '#009A62' },
                error: { icon: '‚ùå', color: '#dc3545', bg: '#ffe6e6', border: '#dc3545' },
                info: { icon: '‚ÑπÔ∏è', color: '#0046FE', bg: '#e8f4ff', border: '#0046FE' },
                warning: { icon: '‚ö†Ô∏è', color: '#ffc107', bg: '#fff3cd', border: '#ffc107' }
            };
            
            const style = config[type] || config.info;
            
            icon.textContent = style.icon;
            text.textContent = message;
            notification.style.borderColor = style.border;
            notification.style.background = style.bg;
            notification.style.color = style.color;
            progressBar.style.background = style.color;
            
            // Mostrar notificaci√≥n
            notification.classList.add('show');
            progressBar.style.animation = 'none';
            setTimeout(() => {
                progressBar.style.animation = 'progress 3s linear';
            }, 10);
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        async function showConfirmation(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const messageEl = document.getElementById('confirmMessage');
                const confirmBtn = document.getElementById('confirmYes');
                const cancelBtn = document.getElementById('confirmNo');
                
                messageEl.textContent = message;
                modal.style.display = 'flex';
                
                confirmBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        }
    </script>

    <!-- Sistema de Notificaciones -->
    <div id="customNotification" class="custom-notification">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span id="notificationIcon" style="font-size: 1.5rem;"></span>
            <span id="notificationText" style="font-weight: 600; flex: 1;"></span>
            <button onclick="document.getElementById('customNotification').classList.remove('show')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.6; color: inherit;">√ó</button>
        </div>
        <div id="notificationProgress" class="notification-progress"></div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="customConfirmModal" class="custom-confirm-modal">
        <div class="custom-confirm-content">
            <div style="font-size: 3rem; text-align: center; margin-bottom: 20px;">üöÄ</div>
            <p id="confirmMessage" style="font-size: 1.1rem; color: #1B1B1B; text-align: center; margin-bottom: 30px; line-height: 1.6;"></p>
            <div style="display: flex; gap: 15px;">
                <button id="confirmNo" class="btn-secondary" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; background: white; color: #666; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                    Cancelar
                </button>
                <button id="confirmYes" style="flex: 1; padding: 12px; background: #0046FE; color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <style>
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid;
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: translateX(calc(100% + 40px));
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 100000;
            overflow: hidden;
        }

        .custom-notification.show {
            transform: translateX(0);
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            transform-origin: left;
        }

        @keyframes progress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }

        .custom-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .custom-confirm-content {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalZoom 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes modalZoom {
            from {
                transform: scale(0.7);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>

    <!-- Modal para Gesti√≥n de Web -->
    <div id="webManagementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="webManagementTitle">‚öôÔ∏è Gestionar Web</h2>
                <button class="close-modal" onclick="closeWebManagementModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="webManagementForm" onsubmit="saveWebManagement(event)">
                    <input type="hidden" id="webManagementClientId">
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                            üìù Cliente / Empresa
                        </label>
                        <p id="webManagementInfo" style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin: 0; color: #666;">
                            -
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="websiteUrlInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                            üåê URL del Sitio Web P√∫blico
                        </label>
                        <input 
                            type="url" 
                            id="websiteUrlInput" 
                            placeholder="https://tusitio.com" 
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;"
                        >
                        <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                            URL del sitio web p√∫blico que ver√°n los visitantes (habilita el bot√≥n "Visitar")
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="wordpressUrlInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                            ‚úèÔ∏è URL de WordPress (Admin)
                        </label>
                        <input 
                            type="url" 
                            id="wordpressUrlInput" 
                            placeholder="https://tusitio.com/wp-admin" 
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;"
                        >
                        <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                            URL del panel de WordPress para que el cliente pueda editar su sitio
                        </small>
                    </div>
                    
                    <!-- Credenciales de WordPress -->
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <p style="margin: 0 0 15px 0; color: #856404; font-weight: 600;">
                            üîê Credenciales de Acceso a WordPress
                        </p>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="wpUsernameInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                üë§ Usuario de WordPress
                            </label>
                            <input 
                                type="text" 
                                id="wpUsernameInput" 
                                placeholder="admin" 
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;"
                            >
                            <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                                Nombre de usuario para acceder al panel de WordPress
                            </small>
                        </div>
                        
                        <div>
                            <label for="wpPasswordInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                üîë Contrase√±a de WordPress
                            </label>
                            <input 
                                type="text" 
                                id="wpPasswordInput" 
                                placeholder="Contrase√±a segura" 
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; font-family: monospace;"
                            >
                            <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                                Contrase√±a de acceso al panel de WordPress (se mostrar√° al cliente cuando el sitio est√© activo)
                            </small>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="screenshotUrlInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                            üì∏ URL de Captura de Pantalla
                        </label>
                        <input 
                            type="url" 
                            id="screenshotUrlInput" 
                            placeholder="https://ejemplo.com/screenshot.jpg" 
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;"
                        >
                        <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                            Opcional: URL de una imagen de captura del sitio web
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="gaPropertyIdInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                            üìä Google Analytics Property ID
                        </label>
                        <input 
                            type="text" 
                            id="gaPropertyIdInput" 
                            placeholder="123456789" 
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; font-family: monospace;"
                        >
                        <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                            Opcional: Property ID de Google Analytics (GA4) para mostrar estad√≠sticas en el dashboard del cliente
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" onclick="closeWebManagementModal()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Cancelar
                        </button>
                        <button type="submit" style="padding: 12px 24px; background: #0046FE; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üíæ Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>
