<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - agutidesigns</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0046FE 0%, #E5FC63 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .checkout-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .checkout-header {
            background: #0046FE;
            padding: 40px;
            color: white;
            text-align: center;
        }

        .checkout-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .checkout-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 40px;
            border-right: 1px solid #e0e0e0;
        }

        .payment-form {
            padding: 40px;
        }

        .summary-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 25px;
            font-weight: 700;
        }

        .plan-card {
            background: white;
            border: 2px solid #0046FE;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .plan-name {
            font-size: 1.3rem;
            color: #0046FE;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .plan-price {
            font-size: 2.5rem;
            color: #333;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .plan-price small {
            font-size: 1rem;
            color: #666;
            font-weight: 400;
        }

        .plan-features {
            list-style: none;
            margin-top: 20px;
        }

        .plan-features li {
            padding: 8px 0;
            color: #666;
            font-size: 0.95rem;
            padding-left: 25px;
            position: relative;
        }

        .plan-features li:before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #009A62;
            font-weight: bold;
        }

        .total-section {
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
            margin-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 1rem;
            color: #666;
        }

        .total-row.final {
            font-size: 1.8rem;
            color: #333;
            font-weight: 800;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #0046FE;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #0046FE;
            box-shadow: 0 0 0 4px rgba(0, 70, 254, 0.1);
        }

        /* Botones de pago r√°pido (Google Pay / Apple Pay) */
        #payment-request-button {
            border-radius: 12px;
            overflow: hidden;
        }

        #payment-request-button button {
            border-radius: 12px !important;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2) !important;
        }

        /* Stripe Elements styling */
        #card-element {
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            transition: all 0.3s ease;
        }

        #card-element.StripeElement--focus {
            border-color: #0046FE;
            box-shadow: 0 0 0 4px rgba(0, 70, 254, 0.1);
        }

        #card-element.StripeElement--invalid {
            border-color: #F1250E;
        }

        #card-errors {
            color: #F1250E;
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 600;
        }

        .btn-pay {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #0046FE 0%, #0036C8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0, 70, 254, 0.3);
        }

        .btn-pay:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 70, 254, 0.4);
        }

        .btn-pay:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .secure-badge {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .secure-badge svg {
            width: 20px;
            height: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0046FE;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .checkout-content {
                grid-template-columns: 1fr;
            }

            .order-summary {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .checkout-header h1 {
                font-size: 2rem;
            }

            .payment-form,
            .order-summary {
                padding: 30px 25px;
            }
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <div class="checkout-header">
            <h1>üí≥ Completar Pago</h1>
            <p>Est√°s a un paso de tener tu web profesional</p>
        </div>

        <div class="checkout-content">
            <!-- Resumen del pedido -->
            <div class="order-summary">
                <h2 class="summary-title">üìã Resumen del Pedido</h2>
                
                <div class="plan-card" id="planCard">
                    <div class="plan-name" id="planName">Plan B√°sico</div>
                    <div class="plan-price">
                        <span id="planPrice">35</span>‚Ç¨<small>/mes</small>
                    </div>
                    <ul class="plan-features" id="planFeatures">
                        <li>Hasta 5 p√°ginas</li>
                        <li>Dominio y hosting incluido</li>
                        <li>Soporte continuo</li>
                    </ul>
                </div>

                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">35,00‚Ç¨</span>
                    </div>
                    <div class="total-row">
                        <span>IVA (21%):</span>
                        <span id="iva">7,35‚Ç¨</span>
                    </div>
                    <div class="total-row final">
                        <span>Total:</span>
                        <span id="total">42,35‚Ç¨</span>
                    </div>
                    <p style="font-size: 0.85rem; color: #999; margin-top: 10px; text-align: center;">
                        Facturaci√≥n mensual recurrente
                    </p>
                </div>
            </div>

            <!-- Formulario de pago -->
            <div class="payment-form">
                <h2 class="summary-title">üí≥ Datos de Pago</h2>
                
                <!-- Botones de pago r√°pido -->
                <div id="payment-request-button" style="margin-bottom: 25px;">
                    <!-- Google Pay / Apple Pay se mostrar√°n aqu√≠ autom√°ticamente -->
                </div>

                <div style="text-align: center; margin: 20px 0; color: #999; font-size: 0.9rem; font-weight: 600;">
                    O paga con tarjeta:
                </div>
                
                <form id="payment-form">
                    <div class="form-group">
                        <label>Nombre en la tarjeta</label>
                        <input type="text" class="form-input" id="cardholder-name" required placeholder="Como aparece en tu tarjeta">
                    </div>

                    <div class="form-group">
                        <label>Email de facturaci√≥n</label>
                        <input type="email" class="form-input" id="billing-email" required placeholder="email@ejemplo.com">
                    </div>

                    <div class="form-group">
                        <label>Datos de la tarjeta</label>
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert"></div>
                    </div>

                    <button type="submit" class="btn-pay" id="submit-button">
                        <span id="button-text">Pagar ahora</span>
                        <span id="spinner" class="spinner" style="display: none;"></span>
                    </button>

                    <div class="secure-badge">
                        <svg fill="#009A62" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                        Pago 100% seguro con encriptaci√≥n SSL
                    </div>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Procesando tu pago...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Obtener datos del sessionStorage
        const orderData = JSON.parse(sessionStorage.getItem('orderData') || '{}');
        
        // Configurar plan
        const planDetails = {
            'basico': { name: 'Plan B√°sico', price: 35, pages: 5 },
            'avanzado': { name: 'Plan Avanzado', price: 49, pages: 10 },
            'premium': { name: 'Plan Premium', price: 65, pages: 20 }
        };

        const plan = orderData.plan || 'basico';
        const details = planDetails[plan];

        // Mostrar informaci√≥n del plan
        document.getElementById('planName').textContent = details.name;
        document.getElementById('planPrice').textContent = details.price;
        document.getElementById('planFeatures').innerHTML = `
            <li>Hasta ${details.pages} p√°ginas</li>
            <li>Dominio y hosting incluido</li>
            <li>Soporte continuo</li>
            <li>Actualizaciones ilimitadas</li>
        `;

        // Calcular totales
        const subtotal = details.price;
        const iva = subtotal * 0.21;
        const total = subtotal + iva;

        document.getElementById('subtotal').textContent = subtotal.toFixed(2) + '‚Ç¨';
        document.getElementById('iva').textContent = iva.toFixed(2) + '‚Ç¨';
        document.getElementById('total').textContent = total.toFixed(2) + '‚Ç¨';

        // Pre-llenar email si existe
        if (orderData.formData && orderData.formData.email) {
            document.getElementById('billing-email').value = orderData.formData.email;
        }

        // Inicializar Stripe Elements
        let stripe, elements, cardElement, paymentRequest;

        async function initStripe() {
            try {
                // Obtener clave p√∫blica de Stripe
                const configResponse = await fetch('https://agutidesigns-production.up.railway.app/api/config');
                const config = await configResponse.json();
                
                stripe = Stripe(config.publishableKey);

                // Crear Payment Request para Google/Apple Pay
                paymentRequest = stripe.paymentRequest({
                    country: 'ES',
                    currency: 'eur',
                    total: {
                        label: details.name,
                        amount: Math.round(total * 100), // Stripe usa centavos
                    },
                    requestPayerName: true,
                    requestPayerEmail: true,
                });

                // Verificar disponibilidad de Google/Apple Pay
                const prButton = elements.create('paymentRequestButton', {
                    paymentRequest: paymentRequest,
                    style: {
                        paymentRequestButton: {
                            type: 'default',
                            theme: 'dark',
                            height: '50px',
                        },
                    },
                });

                // Solo mostrar si est√° disponible
                const canMakePayment = await paymentRequest.canMakePayment();
                if (canMakePayment) {
                    prButton.mount('#payment-request-button');
                } else {
                    document.getElementById('payment-request-button').style.display = 'none';
                    document.querySelector('.payment-form > div:nth-child(3)').style.display = 'none'; // Ocultar "O paga con tarjeta"
                }

                // Manejar pago con Google/Apple Pay
                paymentRequest.on('paymentmethod', async (ev) => {
                    try {
                        // Crear suscripci√≥n
                        const response = await fetch('https://agutidesigns-production.up.railway.app/api/create-subscription', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                paymentMethodId: ev.paymentMethod.id,
                                plan: plan,
                                formData: orderData.formData,
                                billingDetails: {
                                    name: ev.payerName,
                                    email: ev.payerEmail
                                }
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            ev.complete('success');
                            sessionStorage.removeItem('orderData');
                            window.location.href = '/success.html?session_id=' + result.subscriptionId;
                        } else {
                            ev.complete('fail');
                            throw new Error(result.error || 'Error al procesar el pago');
                        }
                    } catch (error) {
                        ev.complete('fail');
                        alert('Error: ' + error.message);
                    }
                });

                // Crear elemento de tarjeta normal
                elements = stripe.elements();
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#333',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                        invalid: {
                            color: '#F1250E',
                            iconColor: '#F1250E'
                        },
                    },
                });

                cardElement.mount('#card-element');

                // Manejar errores en tiempo real
                cardElement.on('change', function(event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
            } catch (error) {
                console.error('Error inicializando Stripe:', error);
                alert('Error al cargar el sistema de pagos. Por favor, recarga la p√°gina.');
            }
        }

        // Inicializar cuando cargue la p√°gina
        initStripe();

        // Manejar env√≠o del formulario
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');

            // Deshabilitar bot√≥n
            submitButton.disabled = true;
            buttonText.textContent = 'Procesando...';
            spinner.style.display = 'inline-block';

            try {
                // Crear Payment Method
                const cardholderName = document.getElementById('cardholder-name').value;
                const billingEmail = document.getElementById('billing-email').value;

                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                        email: billingEmail,
                    },
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Crear suscripci√≥n en el backend
                const response = await fetch('https://agutidesigns-production.up.railway.app/api/create-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paymentMethodId: paymentMethod.id,
                        plan: plan,
                        formData: orderData.formData,
                        billingDetails: {
                            name: cardholderName,
                            email: billingEmail
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Error al procesar el pago');
                }

                const result = await response.json();

                if (result.requiresAction) {
                    // Autenticaci√≥n 3D Secure
                    const {error: confirmError} = await stripe.confirmCardPayment(
                        result.clientSecret
                    );

                    if (confirmError) {
                        throw new Error(confirmError.message);
                    }
                }

                // Pago exitoso
                sessionStorage.removeItem('orderData');
                window.location.href = '/success.html?session_id=' + result.subscriptionId;

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('card-errors').textContent = error.message;
                
                // Rehabilitar bot√≥n
                submitButton.disabled = false;
                buttonText.textContent = 'Pagar ahora';
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html> 